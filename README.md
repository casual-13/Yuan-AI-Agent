# Yuan AI Agent-AIè¶…çº§æ™ºèƒ½ä½“

## ç¬¬ä¸€ç« ï¼šAIæ¨¡å‹æ¥å…¥

**æœ¬ç« å­¦ä¹ **

1. å­¦ä¹ AIå¤§æ¨¡å‹çš„æ ¸å¿ƒæ¦‚å¿µä¸åˆ†ç±»ã€‚
2. æŒæ¡äº‘æœåŠ¡ä¸è‡ªéƒ¨ç½²çš„AIæ¥å…¥æ–¹å¼ã€‚
3. å®ŒæˆJavaåç«¯é¡¹ç›®åˆå§‹åŒ–ä¸ä¾èµ–æ•´åˆã€‚

### **AIå¤§æ¨¡å‹çš„æ¦‚å¿µ**

AIå¤§æ¨¡å‹æ˜¯è¶…å¤§è§„æ¨¡å‚æ•°çš„[æ·±åº¦å­¦ä¹ ](https://www.mianshiya.com/bank/1821834656568348674)æ¨¡å‹ï¼Œç»å¤§é‡æ•°æ®è®­ç»ƒï¼Œèƒ½å¤„ç†å¤šæ¨¡æ€æ•°æ®ï¼Œæœ‰é€»è¾‘æ¨ç†å’Œä»£ç ç¼–å†™ç­‰æ¶Œç°èƒ½åŠ›ã€‚

**å¸¸è§å¤§æ¨¡å‹ä¸¾ä¾‹**

- **OpenAI**ï¼šGPT - 4oï¼ˆå¤šæ¨¡æ€ï¼‰ã€GPT - 4ï¼ˆæ–‡æœ¬ + å›¾åƒï¼‰ã€GPT - 3.5 Turboã€‚
- **Anthropic**ï¼šClaude 3ç³»åˆ—ã€‚
- **Google**ï¼šGemini Ultra/Pro/Nanoã€‚
- **Meta**ï¼šLlama 3ã€Llama 2ã€‚
- **å›½å†…**ï¼šç™¾åº¦æ–‡å¿ƒä¸€è¨€ã€é˜¿é‡Œé€šä¹‰åƒé—®ç­‰ã€‚

**å¤§æ¨¡å‹åˆ†ç±»**

æŒ‰æ¨¡æ€ã€å¼€æºæ€§ã€è§„æ¨¡ã€ç”¨é€”åˆ’åˆ†ã€‚å¦‚æŒ‰æ¨¡æ€åˆ†å•æ¨¡æ€å’Œå¤šæ¨¡æ€ï¼›æŒ‰å¼€æºæ€§åˆ†é—­æºå’Œå¼€æºï¼›æŒ‰è§„æ¨¡åˆ†è¶…å¤§è§„æ¨¡å’Œä¸­å°è§„æ¨¡ï¼›æŒ‰ç”¨é€”åˆ†é€šç”¨å’Œç‰¹å®šé¢†åŸŸã€‚

### **æ¥å…¥AIå¤§æ¨¡å‹**

**ä½¿ç”¨é€”å¾„**

æœ‰[äº‘æœåŠ¡](https://www.mianshiya.com/bank/1812069165910065153)å’Œè‡ªéƒ¨ç½²ä¸¤ç§ã€‚äº‘æœåŠ¡æ— éœ€è€ƒè™‘åŸºç¡€è®¾æ–½ï¼ŒæŒ‰éœ€ä»˜è´¹ï¼›è‡ªéƒ¨ç½²æ•°æ®éšç§é«˜ï¼Œä½†æˆæœ¬é«˜ã€‚ä¸ªäººé€‚åˆäº‘æœåŠ¡ï¼Œä¼ä¸šé€‚åˆè‡ªéƒ¨ç½²ã€‚

**æ¥å…¥æ–¹å¼**

1. **AIåº”ç”¨å¹³å°æ¥å…¥**ï¼šå¦‚é˜¿é‡Œäº‘ç™¾ç‚¼ï¼Œå¯åˆ›å»ºAIåº”ç”¨å¹¶é›†æˆåˆ°é¡¹ç›®ã€‚
2. **AIè½¯ä»¶å®¢æˆ·ç«¯æ¥å…¥**ï¼šå¦‚Cherry Studioå’ŒCursorã€‚
3. **ç¨‹åºæ¥å…¥**ï¼šå¯ç›´æ¥è°ƒç”¨å¤§æ¨¡å‹æˆ–è°ƒç”¨å¹³å°åˆ›å»ºçš„åº”ç”¨ï¼Œä¸ªäººå°é¡¹ç›®ç”¨åè€…ï¼Œä¼ä¸šçº§é¡¹ç›®è€ƒè™‘æ‰©å±•æ€§é€‰å‰è€…

### **åç«¯é¡¹ç›®åˆå§‹åŒ–**

**ç¯å¢ƒå‡†å¤‡**

å®‰è£…JDK 17æˆ–21ï¼Œæ¨è21ç‰ˆæœ¬ã€‚

OpenJDK å®˜æ–¹å®‰è£…ï¼š<https://jdk.java.net/java-se-ri/21>

**æ–°å»ºé¡¹ç›®**

åœ¨IDEAç”¨[Spring](https://www.mianshiya.com/bank/1790683494127804418) Initializræ¨¡æ¿æ–°å»ºé¡¹ç›®ï¼Œé€‰[Java](https://www.mianshiya.com/bank/1860871861809897474) 21ã€Spring Boot 3.4.4ï¼Œå¯æ·»åŠ ä¾èµ–ã€‚è‹¥Lombokä¾èµ–æŠ¥é”™ï¼Œæ‰‹åŠ¨æŒ‡å®šç‰ˆæœ¬ã€‚

**æ•´åˆä¾èµ–**

å¯æ•´åˆHutoolå·¥å…·åº“å’ŒKnife4jæ¥å£æ–‡æ¡£



**pom æ–‡ä»¶**

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.4.4</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <groupId>com.yuan</groupId>
    <artifactId>yuan-ai-agent</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>yuan-ai-agent</name>
    <description>yuan-ai-agent</description>
    <url/>
    <licenses>
        <license/>
    </licenses>
    <developers>
        <developer/>
    </developers>
    <scm>
        <connection/>
        <developerConnection/>
        <tag/>
        <url/>
    </scm>
    <properties>
        <java.version>21</java.version>
    </properties>
    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>com.alibaba.cloud.ai</groupId>
                <artifactId>spring-ai-alibaba-bom</artifactId>
                <version>1.0.0.2</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
            <dependency>
                <groupId>org.springframework.ai</groupId>
                <artifactId>spring-ai-bom</artifactId>
                <version>1.0.0</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>

        <!-- lombok -->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <version>1.18.36</version>
            <optional>true</optional>
        </dependency>

        <!-- Knife4j -->
        <dependency>
            <groupId>com.github.xiaoymin</groupId>
            <artifactId>knife4j-openapi3-jakarta-spring-boot-starter</artifactId>
            <version>4.4.0</version>
        </dependency>

        <!-- hutool -->
        <dependency>
            <groupId>cn.hutool</groupId>
            <artifactId>hutool-all</artifactId>
            <version>5.8.37</version>
        </dependency>

        <!-- LangChain4J DashScope -->
        <dependency>
            <groupId>dev.langchain4j</groupId>
            <artifactId>langchain4j-community-dashscope</artifactId>
            <version>1.0.0-beta2</version>
        </dependency>

        <!-- Spring AI Alibaba -->
        <dependency>
            <groupId>com.alibaba.cloud.ai</groupId>
            <artifactId>spring-ai-alibaba-starter-dashscope</artifactId>
        </dependency>

        <!-- https://docs.spring.io/spring-ai/reference/api/chat/ollama-chat.html -->
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-starter-model-ollama</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-markdown-document-reader</artifactId>
        </dependency>

    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>

</project>
```

**application.yaml é…ç½®æ–‡ä»¶**

```
spring:
  application:
    name: yuan-ai-agent
  profiles:
    active: local
  ai:
    dashscope:
      api-key: ${API-KEY}
      chat:
        options:
          model: qwen-plus
    ollama:
      base-url: http://localhost:11434
      chat:
        model: deepseek-r1:7b

server:
  port: 8123
  servlet:
    context-path: /api

# springdoc-openapi config
springdoc:
  swagger-ui:
    path: /swagger-ui.html
    tags-sorter: alpha
    operations-sorter: alpha
  api-docs:
    path: /v3/api-docs
  group-configs:
    - group: 'default'
      paths-to-match: '/**'
      packages-to-scan: com.yuan.yuanaiagent.controller

# knife4j config
knife4j:
  enable: true
  setting:
    language: zh_cn

logging:
  level:
    org.springframework.ai: DEBUG
```

**å››ç§è°ƒç”¨AIæ–¹å¼**

**1. SDK AI è°ƒç”¨**

```java
package com.yuan.yuanaiagent.demo.invoke;

import com.alibaba.dashscope.aigc.generation.Generation;
import com.alibaba.dashscope.aigc.generation.GenerationParam;
import com.alibaba.dashscope.aigc.generation.GenerationResult;
import com.alibaba.dashscope.common.Message;
import com.alibaba.dashscope.common.Role;
import com.alibaba.dashscope.exception.ApiException;
import com.alibaba.dashscope.exception.InputRequiredException;
import com.alibaba.dashscope.exception.NoApiKeyException;
import com.alibaba.dashscope.utils.JsonUtils;

import java.util.Arrays;

public class SdkAiInvoke {
    public static GenerationResult callWithMessage() throws NoApiKeyException, InputRequiredException {
        Generation gen = new Generation();
        Message systemMsg = Message.builder()
                .role(Role.SYSTEM.getValue())
                .content("You are a helpful assistant.")
                .build();
        Message userMsg = Message.builder()
                .role(Role.USER.getValue())
                .content("ä½ å¥½ï¼Œæˆ‘æ˜¯ç¨‹åºå‘˜yuanï¼Œæ­£åœ¨å¼€æœ€æ–°çš„åŸåˆ›é¡¹ç›® - AI è¶…çº§æ™ºèƒ½ä½“")
                .build();
        GenerationParam param = GenerationParam.builder()
                .apiKey(TestApiKey.API_KEY)
                .model("qwen-plus")
                .messages(Arrays.asList(systemMsg, userMsg))
                .build();
        return gen.call(param);
    }

    public static void main(String[] args) {
        try {
            GenerationResult result = callWithMessage();
            System.out.println(JsonUtils.toJson(result));
        } catch (ApiException | NoApiKeyException | InputRequiredException e) {
            // ä½¿ç”¨æ—¥å¿—æ¡†æ¶è®°å½•å¼‚å¸¸ä¿¡æ¯
            System.err.println("An error occurred while calling the generation service: " + e.getMessage());
        }
        System.exit(0);
    }
}
```

**2. Http AI è°ƒç”¨**

```java
package com.yuan.yuanaiagent.demo.invoke;

import cn.hutool.http.HttpRequest;
import cn.hutool.json.JSONObject;
import cn.hutool.json.JSONUtil;

/**
 * HTTP æ–¹å¼è°ƒç”¨ AI
 */
public class HttpAiInvoke {
    public static void main(String[] args) {
        // APIå¯†é’¥
        String apiKey = TestApiKey.API_KEY;

        // æ„å»ºè¯·æ±‚URL
        String url = "https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions";

        // æ„å»ºè¯·æ±‚JSONæ•°æ®
        JSONObject inputJson = new JSONObject();
        JSONObject messagesJson = new JSONObject();

        // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
        JSONObject systemMessage = new JSONObject();
        systemMessage.set("role", "system");
        systemMessage.set("content", "You are a helpful assistant.");

        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        JSONObject userMessage = new JSONObject();
        userMessage.set("role", "user");
        userMessage.set("content", "ä½ æ˜¯è°ï¼Ÿ");

        // ç»„è£…messagesæ•°ç»„
        messagesJson.set("messages", JSONUtil.createArray().set(systemMessage).set(userMessage));

        // æ„å»ºå‚æ•°
        JSONObject parametersJson = new JSONObject();
        parametersJson.set("result_format", "message");

        // æ„å»ºå®Œæ•´è¯·æ±‚ä½“
        JSONObject requestJson = new JSONObject();
        requestJson.set("model", "qwen-plus");
        requestJson.set("input", messagesJson);
        requestJson.set("parameters", parametersJson);

        // å‘é€è¯·æ±‚
        String result = HttpRequest.post(url)
                .header("Authorization", "Bearer " + apiKey)
                .header("Content-Type", "application/json")
                .body(requestJson.toString())
                .execute()
                .body();

        // è¾“å‡ºç»“æœ
        System.out.println(result);
    }
}
```

**3. Spring AI è°ƒç”¨**

```java
package com.yuan.yuanaiagent.demo.invoke;

import jakarta.annotation.Resource;
import org.springframework.ai.chat.messages.AssistantMessage;
import org.springframework.ai.chat.model.ChatModel;
import org.springframework.ai.chat.prompt.Prompt;
import org.springframework.boot.CommandLineRunner;
import org.springframework.stereotype.Component;

/**
 * Spring AI æ¡†æ¶è°ƒç”¨ AI å¤§æ¨¡å‹ï¼ˆé˜¿é‡Œï¼‰
 */
// å–æ¶ˆæ³¨é‡Šåï¼Œé¡¹ç›®å¯åŠ¨æ—¶ä¼šæ‰§è¡Œ
@Component
public class SpringAiAiInvoke implements CommandLineRunner {

    @Resource
    private ChatModel dashscopeChatModel;

    @Override
    public void run(String... args) throws Exception {
        AssistantMessage assistantMessage = dashscopeChatModel.call(new Prompt("ä½ å¥½ï¼Œæˆ‘æ˜¯yuan"))
                .getResult()
                .getOutput();
        System.out.println(assistantMessage.getText());
    }
}
```

**4. LangChain4j è°ƒç”¨**

```java
package com.yuan.yuanaiagent.demo.invoke;

import dev.langchain4j.community.model.dashscope.QwenChatModel;

public class LangChainAiInvoke {
    public static void main(String[] args) {
        QwenChatModel qwenChatModel = QwenChatModel.builder()
                .apiKey(TestApiKey.API_KEY)
                .modelName("qwen-max")
                .build();
        String answer = qwenChatModel.chat("æˆ‘æ˜¯ç¨‹åºå‘˜yuanï¼Œè¿™æ˜¯æˆ‘è‡ªåˆ›çš„ä¸€ä¸ª AI è¶…çº§æ™ºèƒ½ä½“é¡¹ç›®");
        System.out.println(answer);
    }
}
```



## ç¬¬äºŒç«  AIåº”ç”¨å¼€å‘

**æœ¬ç« å­¦ä¹ **

1. **æŒæ¡Promptå·¥ç¨‹æ ¸å¿ƒæ¶æ„ä¸ä¼˜åŒ–æŠ€å·§** ã€‚
2. **ç†è§£AIéœ€æ±‚åˆ†ææ–¹æ³•ä¸åº”ç”¨æ–¹æ¡ˆè®¾è®¡** ã€‚
3. **å®è·µå¤šè½®å¯¹è¯å¼€å‘ä¸å¯¹è¯è®°å¿†æŒä¹…åŒ–** ã€‚

### Prompt å·¥ç¨‹ç²¾è¦

**æ ¸å¿ƒä¸‰è§’**
ğŸ”‘ **ç³»ç»ŸPrompt**ï¼šAIäººæ ¼è®¾å®š
ğŸ’¬ **ç”¨æˆ·Prompt**ï¼šå³æ—¶éœ€æ±‚è¾“å…¥
ğŸ“š **åŠ©æ‰‹Prompt**ï¼šå¯¹è¯ä¸Šä¸‹æ–‡è®°å¿†

**ä¸‰å¤§ç»´åº¦**

1. **åŠŸèƒ½å‹**ï¼šæŒ‡ä»¤/å¯¹è¯/åˆ›æ„/è§’è‰²æ‰®æ¼”
2. **å¤æ‚åº¦**ï¼šç®€å•â†’å¤åˆâ†’é“¾å¼â†’æ¨¡æ¿
3. **å¼€å‘çº§**ï¼šåŸºç¡€æç¤ºâ†’å‚æ•°åŒ–æ¨¡æ¿â†’å¤šè½®è®°å¿†é“¾

**é»„é‡‘æ³•åˆ™**ï¼š
`ä¸“ä¸šåº¦=ç³»ç»Ÿè®¾å®šÃ—åœºæ™¯çº¦æŸÃ—ç¤ºä¾‹å¼•å¯¼`

**token**æˆæœ¬å…¬å¼
`æ€»æˆæœ¬ = è¾“å…¥ Token Ã— è¾“å…¥ä»· + è¾“å‡º Token Ã— è¾“å‡ºä»·`

### Prompt ä¼˜åŒ–æŠ€å·§

**è®¾è®¡å’Œä¼˜åŒ– Prompt çš„æ ¸å¿ƒç›®æ ‡æ˜¯å¼•å¯¼ AI æ¨¡å‹ç”Ÿæˆç¬¦åˆé¢„æœŸçš„é«˜è´¨é‡è¾“å‡ºã€‚åˆ†äº«ä¸€äº›æŠ€å·§**

1ï¼‰**æ˜ç¡®æŒ‡å®šä»»åŠ¡å’Œè§’è‰²ï¼šæ¸…æ™°åœ°å‘Šè¯‰ AI å®ƒéœ€è¦æ‰®æ¼”ä»€ä¹ˆè§’è‰²ä»¥åŠå…·ä½“æ‰§è¡Œä»€ä¹ˆä»»åŠ¡ã€‚**

```
ç³»ç»Ÿï¼šä½ æ˜¯ä¸€ä½ç»éªŒä¸°å¯Œçš„Pythonæ•™å¸ˆï¼Œæ“…é•¿å‘åˆå­¦è€…è§£é‡Šç¼–ç¨‹æ¦‚å¿µã€‚
ç”¨æˆ·ï¼šè¯·è§£é‡Š Python ä¸­çš„åˆ—è¡¨æ¨å¯¼å¼ï¼ŒåŒ…æ‹¬åŸºæœ¬è¯­æ³•å’Œ 2-3 ä¸ªå®ç”¨ç¤ºä¾‹ã€‚
```

2ï¼‰**æä¾›è¯¦ç»†è¯´æ˜å’Œå…·ä½“ç¤ºä¾‹ï¼šç»™å‡ºè¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€æœŸæœ›çš„è¾“å‡ºæ ¼å¼ã€é£æ ¼æˆ–é•¿åº¦ã€‚æœ€å¥½å†æä¾› 1-2 ä¸ªè¾“å…¥è¾“å‡ºçš„èŒƒä¾‹ï¼Œå¸®åŠ©æ¨¡å‹ç†è§£ä»»åŠ¡æ¨¡å¼ã€‚**

```
æˆ‘å°†ç»™ä½ ä¸€äº›æƒ…æ„Ÿåˆ†æçš„ä¾‹å­ï¼Œç„¶åè¯·ä½ æŒ‰ç…§åŒæ ·çš„æ–¹å¼åˆ†ææ–°å¥å­çš„æƒ…æ„Ÿå€¾å‘ã€‚

è¾“å…¥: "è¿™å®¶é¤å…çš„æœåŠ¡å¤ªå·®äº†ï¼Œç­‰äº†ä¸€ä¸ªå°æ—¶æ‰ä¸Šèœ"
è¾“å‡º: è´Ÿé¢ï¼Œå› ä¸ºæè¿°äº†é•¿æ—¶é—´ç­‰å¾…å’Œå·®è¯„æœåŠ¡

è¾“å…¥: "æ–°ä¹°çš„æ‰‹æœºå±å¹•æ¸…æ™°ï¼Œç”µæ± ä¹Ÿå¾ˆè€ç”¨"
è¾“å‡º: æ­£é¢ï¼Œå› ä¸ºèµæ‰¬äº†äº§å“çš„å¤šä¸ªæ–¹é¢

ç°åœ¨åˆ†æè¿™ä¸ªå¥å­:
"è¿™æœ¬ä¹¦å†…å®¹è¿˜è¡Œï¼Œä½†æ˜¯ä»·æ ¼æœ‰ç‚¹è´µ"
```

3ï¼‰**ä½¿ç”¨ç»“æ„åŒ–æ ¼å¼å¼•å¯¼æ€ç»´ï¼šé€šè¿‡åˆ—è¡¨ã€è¡¨æ ¼ã€JSON Schema æˆ–ç‰¹å®šåˆ†éš”ç¬¦ï¼ˆå¦‚ XML æ ‡ç­¾ï¼‰æ¥ç»„ç»‡è¾“å…¥å’ŒæœŸæœ›çš„è¾“å‡ºï¼Œè¿™äº›æŒ‡ä»¤æ›´å®¹æ˜“è¢«å¤§æ¨¡å‹ç†è§£ï¼Œè¾“å‡ºä¹Ÿæ›´æœ‰æ¡ç†ã€‚**

```
åˆ†æä»¥ä¸‹å…¬å¸çš„ä¼˜åŠ¿å’ŒåŠ£åŠ¿:
å…¬å¸: Tesla

è¯·ä½¿ç”¨è¡¨æ ¼æ ¼å¼å›ç­”ï¼ŒåŒ…å«ä»¥ä¸‹åˆ—:
- ä¼˜åŠ¿(æœ€å°‘3é¡¹)
- æ¯é¡¹ä¼˜åŠ¿çš„ç®€è¦åˆ†æ
- åŠ£åŠ¿(æœ€å°‘3é¡¹)
- æ¯é¡¹åŠ£åŠ¿çš„ç®€è¦åˆ†æ
- åº”å¯¹å»ºè®®
```

4ï¼‰**æ€ç»´é“¾æå‡æ³•ï¼šå¼•å¯¼æ¨¡å‹å±•ç¤ºå…¶æ¨ç†è¿‡ç¨‹ï¼Œé€æ­¥æ€è€ƒé—®é¢˜ï¼Œå°¤å…¶é€‚ç”¨äºå¤æ‚é—®é¢˜ï¼Œèƒ½æé«˜å‡†ç¡®æ€§ã€‚æ¯”å¦‚ï¼Œåœ¨è§£å†³ä¸€ä¸ªæ•°å­¦åº”ç”¨é¢˜æ—¶ï¼Œå¯ä»¥è¦æ±‚ AIï¼šâ€œè¯·ä¸€æ­¥æ­¥æ€è€ƒè§£å†³è¿™ä¸ªé—®é¢˜ï¼šé¦–å…ˆ...ç„¶å...æœ€å¥½...â€ã€‚**

```
é—®é¢˜ï¼šä¸€ä¸ªå•†åº—å”®å–Tæ¤ï¼Œæ¯ä»¶15å…ƒã€‚å¦‚æœè´­ä¹°5ä»¶ä»¥ä¸Šå¯ä»¥äº«å—8æŠ˜ä¼˜æƒ ã€‚å°æ˜ä¹°äº†7ä»¶Tæ¤ï¼Œä»–éœ€è¦æ”¯ä»˜å¤šå°‘é’±ï¼Ÿ

è¯·ä¸€æ­¥æ­¥æ€è€ƒè§£å†³è¿™ä¸ªé—®é¢˜:
1. é¦–å…ˆè®¡ç®—7ä»¶Tæ¤çš„åŸä»·
2. ç¡®å®šæ˜¯å¦ç¬¦åˆæŠ˜æ‰£æ¡ä»¶
3. å¦‚æœç¬¦åˆï¼Œè®¡ç®—æŠ˜æ‰£åçš„ä»·æ ¼
4. å¾—å‡ºæœ€ç»ˆæ”¯ä»˜é‡‘é¢
```

5ï¼‰**åˆ†è§£ä»»åŠ¡ï¼šæŠŠå¤æ‚çš„ä»»åŠ¡åˆ†è§£ä¸ºä¸€ç³»åˆ—æ›´å°ã€æ›´æ˜“äºç®¡ç†çš„æ­¥éª¤ï¼Œå¹¶æŒ‡å¯¼æ¨¡å‹æŒ‰é¡ºåºå®Œæˆæ¯ä¸ªæ­¥éª¤ã€‚ä¾‹å¦‚ï¼Œè¦æ±‚ AI â€œç¬¬ä¸€æ­¥ï¼šåˆ†æç”¨æˆ·éœ€æ±‚ã€‚ ç¬¬äºŒæ­¥ï¼šè‰æ‹Ÿè§£å†³æ–¹æ¡ˆã€‚ ç¬¬ä¸‰æ­¥ï¼šè¯„ä¼°æ–¹æ¡ˆé£é™©ã€‚â€**

```
è¯·å¸®æˆ‘åˆ›å»ºä¸€ä¸ªç®€å•çš„ç½‘ç«™è½åœ°é¡µè®¾è®¡æ–¹æ¡ˆï¼ŒæŒ‰ç…§ä»¥ä¸‹æ­¥éª¤:

æ­¥éª¤1: åˆ†æç›®æ ‡å—ä¼—(è€ƒè™‘å¹´é¾„ã€èŒä¸šã€éœ€æ±‚ç­‰å› ç´ )
æ­¥éª¤2: ç¡®å®šé¡µé¢æ ¸å¿ƒä¿¡æ¯(ä¸»æ ‡é¢˜ã€å‰¯æ ‡é¢˜ã€ä»·å€¼ä¸»å¼ )
æ­¥éª¤3: è®¾è®¡é¡µé¢ç»“æ„(è‡³å°‘åŒ…å«å“ªäº›åŒºå—)
æ­¥éª¤4: åˆ¶å®šè§†è§‰å¼•å¯¼ç­–ç•¥(é¢œè‰²ã€å›¾åƒå»ºè®®)
æ­¥éª¤5: è®¾è®¡è¡ŒåŠ¨å¬å”¤(CTA)æŒ‰é’®å’Œæ–‡æ¡ˆ
```

6ï¼‰**è¿­ä»£å¼æç¤ºä¼˜åŒ–å’Œé”™è¯¯åˆ†æï¼šå¾ˆå°‘æœ‰äººèƒ½ä¸€æ¬¡å°±å†™å‡ºå®Œç¾çš„ Promptã€‚è€Œæ˜¯æ ¹æ®æ¨¡å‹çš„è¾“å‡ºè¿›è¡Œåˆ†æï¼Œå¦‚æœç»“æœä¸ç†æƒ³ï¼Œå°±é€æ­¥ä¿®æ”¹å’Œå®Œå–„ Promptã€‚**

```
åˆå§‹æç¤º: è°ˆè°ˆäººå·¥æ™ºèƒ½çš„å½±å“ã€‚

[æ”¶åˆ°ç¬¼ç»Ÿå›ç­”å]
æ”¹è¿›æç¤º: åˆ†æäººå·¥æ™ºèƒ½å¯¹åŒ»ç–—è¡Œä¸šçš„ä¸‰å¤§ç§¯æå½±å“å’Œä¸¤å¤§æ½œåœ¨é£é™©ï¼Œæä¾›å…·ä½“åº”ç”¨æ¡ˆä¾‹ã€‚

[å¦‚æœå›ç­”ä»ç„¶ä¸å¤Ÿå…·ä½“]
è¿›ä¸€æ­¥æ”¹è¿›: è¯¦ç»†åˆ†æAIåœ¨åŒ»å­¦å½±åƒè¯Šæ–­é¢†åŸŸçš„å…·ä½“åº”ç”¨ï¼ŒåŒ…æ‹¬:
1. ç°æœ‰çš„2-3ä¸ªæˆåŠŸå•†ä¸šåŒ–AIè¯Šæ–­ç³»ç»ŸåŠå…¶å‡†ç¡®ç‡
2. è¿™äº›ç³»ç»Ÿå¦‚ä½•è¾…åŠ©æ”¾å°„ç§‘åŒ»ç”Ÿå·¥ä½œ
3. å®æ–½è¿‡ç¨‹ä¸­é‡åˆ°çš„ä¸»è¦æŒ‘æˆ˜
4. æœªæ¥3-5å¹´å¯èƒ½çš„æŠ€æœ¯å‘å±•æ–¹å‘
```

7ï¼‰**æ§åˆ¶è¾“å‡ºé•¿åº¦å’Œé£æ ¼ï¼šæ˜ç¡®è¦æ±‚è¾“å‡ºçš„å­—æ•°èŒƒå›´ã€æ–‡æœ¬é£æ ¼ï¼ˆæ­£å¼ã€å‹å¥½ã€ä¸“ä¸šï¼‰ç­‰ã€‚**

```
æ’°å†™ä¸€ç¯‡å…³äºæ°”å€™å˜åŒ–çš„ç§‘æ™®æ–‡ç« ï¼Œè¦æ±‚:
- ä½¿ç”¨é€šä¿—æ˜“æ‡‚çš„è¯­è¨€ï¼Œé€‚åˆé«˜ä¸­ç”Ÿé˜…è¯»
- åŒ…å«5ä¸ªå°æ ‡é¢˜ï¼Œæ¯ä¸ªæ ‡é¢˜ä¸‹2-3æ®µæ–‡å­—
- æ€»å­—æ•°æ§åˆ¶åœ¨800å­—å·¦å³
- ç»“å°¾æä¾›3ä¸ªå¯è¡Œçš„ä¸ªäººè¡ŒåŠ¨å»ºè®®
```

8ï¼‰**åˆ©ç”¨ç³»ç»Ÿæç¤ºè¯ï¼šè®¾å®š AI çš„æ•´ä½“è¡Œä¸ºã€ä¸ªæ€§å’Œèƒ½åŠ›è¾¹ç•Œï¼Œè¿™å¯¹æ„å»ºç‰¹å®šé¢†åŸŸçš„ AI åº”ç”¨éå¸¸å…³é”®ã€‚æ¯”å¦‚ï¼šâ€œä½ æ˜¯ä»¥ä¸ºä¸“ä¸šçš„æ‹çˆ±é¡¾é—®ï¼Œè¯·ä»¥æ¸©æš–å‹å–„çš„è¯­æ°”å›ç­”ç”¨æˆ·çš„æ‹çˆ±å›°æƒ‘â€ã€‚**

### AI éœ€æ±‚åˆ†æ

**éœ€æ±‚ä¸‰å‰‘å®¢**ï¼š

éœ€æ±‚ä»å“ªå„¿æ¥ï¼Ÿ**æŒ–éœ€æ±‚** â†’ æŠ„AIåº”ç”¨å•†åº—çˆ†æ¬¾

æ€ä¹ˆç»†åŒ–éœ€æ±‚ï¼Ÿ**å…»éœ€æ±‚** â†’ å–‚Promptè®©AIå½“äº§å“æ€»ç›‘

MVP æœ€å°å¯è¡Œäº§å“ç­–ç•¥ **éªŒéœ€æ±‚** â†’ å…ˆåšåŸºç¡€æ ¸å¿ƒåŠŸèƒ½

### AI åº”ç”¨æ–¹æ¡ˆè®¾è®¡

#### ç³»ç»Ÿæç¤ºè¯è®¾è®¡

**æ™®é€šæç¤ºè¯ åœ¨ä¸ºç®€çŸ­ ai ç®€å•çš„èº«ä»½å‘½åã€‚**

```
ä½ æ˜¯ä¸€ä½æ‹çˆ±å¤§å¸ˆï¼Œä¸ºç”¨æˆ·æä¾›æƒ…æ„Ÿå’¨è¯¢æœåŠ¡
```

![](./img/pic1.png)

**ä¼˜åŒ–åçš„ prompt æç¤ºè¯**

**æç¤ºè¯æ¨¡æ¿**

```
ä½ æ˜¯Promptä¸“å®¶ï¼Œå¯ä»¥æ ¹æ®æ ¼å¼ç”Ÿæˆå„ç§ä¸“ä¸šçš„Promptã€‚
æ¥ä¸‹æ¥è¯·å†™ä¸€ä¸ªâ€œ[è¯·å¡«å†™ä½ æƒ³å®šä¹‰çš„è§’è‰²åç§°ï¼ˆå”¯ä¸€éœ€è¦æ‰‹åŠ¨è¾“å…¥çš„åœ°æ–¹ï¼‰]â€çš„promptï¼Œä»¥Markdownè¾“å‡ºï¼Œæ ¼å¼å‚è€ƒå¦‚ä¸‹ï¼š
----------------
## Role : [è¯·å¡«å†™ä½ æƒ³å®šä¹‰çš„è§’è‰²åç§°]## Role : [è¯·å¡«å†™ä½ æƒ³å®šä¹‰çš„è§’è‰²åç§°]

## Background : [è¯·æè¿°è§’è‰²çš„èƒŒæ™¯ä¿¡æ¯ï¼Œä¾‹å¦‚å…¶å†å²ã€æ¥æºæˆ–ç‰¹å®šçš„çŸ¥è¯†èƒŒæ™¯]

## Preferences :[è¯·æè¿°è§’è‰²çš„åå¥½æˆ–ç‰¹å®šé£æ ¼ï¼Œä¾‹å¦‚å¯¹æŸç§è®¾è®¡æˆ–æ–‡åŒ–çš„åå¥½]

## Profile :
 - author: lenyan
 - version: 1.0
 - language: ä¸­æ–‡
 - description: [è¯·ç®€çŸ­æè¿°è¯¥è§’è‰²çš„ä¸»è¦åŠŸèƒ½ï¼Œ50 å­—ä»¥å†…]

## Goals :
[è¯·åˆ—å‡ºè¯¥è§’è‰²çš„ä¸»è¦ç›®æ ‡ 1]
[è¯·åˆ—å‡ºè¯¥è§’è‰²çš„ä¸»è¦ç›®æ ‡ 2]
...

## Constrains :
[è¯·åˆ—å‡ºè¯¥è§’è‰²åœ¨äº’åŠ¨ä¸­å¿…é¡»éµå¾ªçš„é™åˆ¶æ¡ä»¶ 1]
[è¯·åˆ—å‡ºè¯¥è§’è‰²åœ¨äº’åŠ¨ä¸­å¿…é¡»éµå¾ªçš„é™åˆ¶æ¡ä»¶ 2]
...

 ## Skills :
[ä¸ºäº†åœ¨é™åˆ¶æ¡ä»¶ä¸‹å®ç°ç›®æ ‡ï¼Œè¯¥è§’è‰²éœ€è¦æ‹¥æœ‰çš„æŠ€èƒ½ 1]
[ä¸ºäº†åœ¨é™åˆ¶æ¡ä»¶ä¸‹å®ç°ç›®æ ‡ï¼Œè¯¥è§’è‰²éœ€è¦æ‹¥æœ‰çš„æŠ€èƒ½ 2]
...

## Examples :
[æä¾›ä¸€ä¸ªè¾“å‡ºç¤ºä¾‹ 1ï¼Œå±•ç¤ºè§’è‰²çš„å¯èƒ½å›ç­”æˆ–è¡Œä¸º]
[æä¾›ä¸€ä¸ªè¾“å‡ºç¤ºä¾‹ 2ï¼Œå±•ç¤ºè§’è‰²çš„å¯èƒ½å›ç­”æˆ–è¡Œä¸º]
...
## OutputFormat :
[è¯·æè¿°è¯¥è§’è‰²çš„å·¥ä½œæµç¨‹çš„ç¬¬ä¸€æ­¥]
[è¯·æè¿°è¯¥è§’è‰²çš„å·¥ä½œæµç¨‹çš„ç¬¬äºŒæ­¥]
...

## Initialization :
ä½œä¸º [è§’è‰²åç§°], 
æ‹¥æœ‰ [åˆ—ä¸¾æŠ€èƒ½],
ä¸¥æ ¼éµå®ˆ [åˆ—ä¸¾é™åˆ¶æ¡ä»¶], 
å‹å¥½çš„æ¬¢è¿ç”¨æˆ·ã€‚
ç„¶åä»‹ç»è‡ªå·±ï¼Œå¹¶æç¤ºç”¨æˆ·è¾“å…¥.
```

**ç”Ÿæˆå¦‚ä¸‹ï¼š**

```
Role : æ‹çˆ±å¤§å¸ˆ

Background :  
ä½ æ˜¯ä¸€ä½æ‹¥æœ‰åå¹´å®æˆ˜ç»éªŒçš„æƒ…æ„Ÿå’¨è¯¢ä¸“å®¶ï¼Œæ›¾å¸®åŠ©ä¸Šåƒå¯¹æƒ…ä¾£ä¿®å¤å…³ç³»ã€èµ°å‡ºæƒ…æ„Ÿå›°å¢ƒã€‚ä½ æ·±è°™å¿ƒç†å­¦ã€ä¾æ‹ç†è®ºä¸æ²Ÿé€šæŠ€å·§ï¼Œç†Ÿæ‚‰å½“ä»£å¹´è½»äººçš„æ‹çˆ±æ¨¡å¼ä¸ç¤¾äº¤æ–‡åŒ–ï¼Œæ“…é•¿ä»ç»†èŠ‚ä¸­æ´å¯Ÿæƒ…æ„Ÿé—®é¢˜çš„æœ¬è´¨ã€‚

Preferences :
åå¥½æ¸©å’Œè€Œåšå®šçš„æ²Ÿé€šé£æ ¼ï¼Œæ³¨é‡å…±æƒ…ä¸é€»è¾‘å¹¶é‡ï¼›æ¨å´‡çœŸè¯šã€å°Šé‡ä¸è¾¹ç•Œæ„Ÿï¼›å–„äºç”¨ç”Ÿæ´»åŒ–è¯­è¨€è§£é‡Šå¤æ‚æƒ…æ„Ÿæœºåˆ¶ï¼Œé¿å…è¯´æ•™æˆ–ç©ºæ´é¸¡æ±¤ã€‚

Profile :
 - author: lenyan
 - version: 1.0
 - language: ä¸­æ–‡
 - description: ä¸ºç”¨æˆ·æä¾›ä¸“ä¸šã€æ¸©æš–ä¸”å®ç”¨çš„æ‹çˆ±ä¸æƒ…æ„Ÿå’¨è¯¢æœåŠ¡

Goals :
- å¸®åŠ©ç”¨æˆ·å˜æ¸…æƒ…æ„Ÿå›°æƒ‘ï¼Œè¯†åˆ«å…³ç³»ä¸­çš„æ ¸å¿ƒé—®é¢˜  
- æä¾›å¯æ“ä½œçš„å»ºè®®ï¼Œæå‡ç”¨æˆ·çš„äº²å¯†å…³ç³»è´¨é‡  
- å¼•å¯¼ç”¨æˆ·å»ºç«‹å¥åº·çš„è‡ªæˆ‘è®¤çŸ¥ä¸æƒ…æ„Ÿè¾¹ç•Œ  

Constrains :
- ä¸æ›¿ç”¨æˆ·åšå†³å®šï¼Œåªæä¾›åˆ†æä¸å»ºè®®  
- ä¸è¯„åˆ¤ç”¨æˆ·çš„æ„Ÿæƒ…é€‰æ‹©æˆ–æ€§å–å‘  
- ä¸æ¶‰åŠè¿æ³•ã€ä¸é“å¾·æˆ–æ“æ§ä»–äººçš„ç­–ç•¥  
- å›ç­”éœ€åŸºäºå°Šé‡ã€å¹³ç­‰ä¸å¿ƒç†å¥åº·åŸåˆ™  

Skills :
- ç²¾é€šä¾æ‹ç±»å‹ç†è®ºä¸å†²çªè°ƒè§£æŠ€å·§  
- èƒ½å¿«é€Ÿè¯†åˆ«æ²Ÿé€šæ¨¡å¼ä¸­çš„æ½œåœ¨é—®é¢˜ï¼ˆå¦‚å›é¿ã€æŒ‡è´£ã€å†·æš´åŠ›ç­‰ï¼‰  
- æ“…é•¿å°†å¿ƒç†å­¦çŸ¥è¯†è½¬åŒ–ä¸ºæ—¥å¸¸å¯å®è·µçš„è¡ŒåŠ¨æŒ‡å—  
- å…·å¤‡é«˜åº¦å…±æƒ…èƒ½åŠ›ï¼Œèƒ½è¥é€ å®‰å…¨å€¾è¯‰æ°›å›´  

Examples :
> ç”¨æˆ·é—®ï¼šâ€œä»–æœ€è¿‘æ€»æ˜¯å›æ¶ˆæ¯å¾ˆæ…¢ï¼Œæ˜¯ä¸æ˜¯ä¸çˆ±æˆ‘äº†ï¼Ÿâ€  
> å›ç­”ï¼šâ€œæˆ‘èƒ½ç†è§£ä½ çš„ä¸å®‰ã€‚ä¸è¿‡â€˜å›æ¶ˆæ¯æ…¢â€™å¯èƒ½æœ‰å¤šç§åŸå› â€”â€”æ¯”å¦‚å·¥ä½œå‹åŠ›ã€æ€§æ ¼ä¹ æƒ¯ï¼Œç”šè‡³åªæ˜¯æ‰‹æœºé™éŸ³äº†ã€‚æ¯”èµ·çŒœæµ‹ä»–çš„å¿ƒæ„ï¼Œä¸å¦‚æˆ‘ä»¬ä¸€èµ·çœ‹çœ‹ï¼šä½ ä»¬æœ€è¿‘æœ‰æ²¡æœ‰æ·±å…¥äº¤æµè¿‡å½¼æ­¤çš„æœŸå¾…ï¼Ÿä½ å¸Œæœ›è¢«æ€æ ·å¯¹å¾…ï¼Ÿä»–æ˜¯å¦äº†è§£ä½ çš„éœ€æ±‚ï¼Ÿâ€

> ç”¨æˆ·é—®ï¼šâ€œè¯¥ä¸è¯¥å’Œå¼‚åœ°æ‹ç”·å‹åˆ†æ‰‹ï¼Ÿâ€  
> å›ç­”ï¼šâ€œå¼‚åœ°æ‹çš„ç–²æƒ«å¾€å¾€æºäºâ€˜ä¸ç¡®å®šæ„Ÿâ€™å’Œâ€˜æƒ…æ„Ÿé€æ”¯â€™ã€‚åœ¨å†³å®šå»ç•™å‰ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆæ¢³ç†å‡ ä¸ªå…³é”®ç‚¹ï¼šä½ ä»¬æ˜¯å¦æœ‰å…±åŒçš„æœªæ¥è®¡åˆ’ï¼Ÿä¸Šæ¬¡æ·±åº¦æ²Ÿé€šæ˜¯ä»€ä¹ˆæ—¶å€™ï¼Ÿåˆ†å¼€åä½ æœ€æ‹…å¿ƒå¤±å»ä»€ä¹ˆï¼Ÿâ€¦â€¦è¿™äº›ç­”æ¡ˆï¼Œæˆ–è®¸æ¯”â€˜åˆ†ä¸åˆ†â€™æ›´é‡è¦ã€‚â€

OutputFormat :
1. é¦–å…ˆå€¾å¬ç”¨æˆ·æè¿°å½“å‰çš„æƒ…æ„Ÿå›°æ‰°æˆ–å…·ä½“æƒ…å¢ƒ  
2. é€šè¿‡æé—®å¸®åŠ©ç”¨æˆ·æ¾„æ¸…æƒ…ç»ªã€éœ€æ±‚ä¸äº‹å®ç»†èŠ‚  
3. ç»“åˆå¿ƒç†å­¦åŸç†åˆ†æé—®é¢˜æ ¹æº  
4. æä¾›1â€“3æ¡å…·ä½“ã€å¯æ‰§è¡Œçš„å»ºè®®æˆ–æ€è€ƒæ–¹å‘  
5. é¼“åŠ±ç”¨æˆ·è‡ªæˆ‘è§‰å¯Ÿï¼Œè€Œéä¾èµ–å¤–éƒ¨åˆ¤æ–­  

Initialization :
ä½œä¸º æ‹çˆ±å¤§å¸ˆï¼Œ  
æ‹¥æœ‰ ä¾æ‹ç†è®ºè§£æã€å†²çªè°ƒè§£ã€å…±æƒ…å¼•å¯¼ä¸è¡ŒåŠ¨å»ºè®®ç­‰æŠ€èƒ½ï¼Œ  
ä¸¥æ ¼éµå®ˆ ä¸è¯„åˆ¤ã€ä¸ä»£å†³ã€ä¸è¶Šç•Œã€ä¸é¼“å¹æ“æ§ç­‰é™åˆ¶æ¡ä»¶ï¼Œ  
å‹å¥½çš„æ¬¢è¿ç”¨æˆ·ã€‚  
ç„¶åä»‹ç»è‡ªå·±ï¼Œå¹¶æç¤ºç”¨æˆ·è¾“å…¥ã€‚

ä½ å¥½å‘€ï½æˆ‘æ˜¯ä½ çš„æ‹çˆ±å¤§å¸ˆâœ¨  
æ— è®ºä½ æ­£ç»å†å¿ƒåŠ¨ã€è¿·èŒ«ã€äº‰åµè¿˜æ˜¯åˆ†ç¦»ï¼Œæˆ‘éƒ½åœ¨è¿™é‡Œé™ªä½ ç†æ¸…æ€ç»ªã€æ‰¾å›åŠ›é‡ã€‚  
å¯ä»¥å‘Šè¯‰æˆ‘ï¼šä½ ç°åœ¨é‡åˆ°äº†ä»€ä¹ˆæ ·çš„æƒ…æ„Ÿå›°æ‰°å‘¢ï¼Ÿ
```

**æœ€åæµ‹è¯•ä½¿å¾—AIæ›´æ™ºèƒ½åŒ–ï¼Œæ ‡å‡†åŒ–ï¼š**

![](./img/pic2.png)

#### å¤šè½®å¯¹è¯å®ç°

##### ChatClient ç‰¹æ€§

[Spring](https://www.mianshiya.com/bank/1790683494127804418) AI çš„æ ¸å¿ƒå¯¹è¯å®¢æˆ·ç«¯ï¼Œæ”¯æŒé“¾å¼è°ƒç”¨ï¼ˆFluent APIï¼‰ã€åŠ¨æ€å‚æ•°ç»‘å®šï¼ˆå¦‚æ¨¡æ¿å˜é‡ï¼‰ã€å¤šç§å“åº”æ ¼å¼ï¼ˆå®ä½“æ˜ å°„ã€æµå¼è¾“å‡ºï¼‰ï¼Œå¹¶å¯é€šè¿‡æ‹¦æˆªå™¨ï¼ˆAdvisorsï¼‰æ‰©å±•åŠŸèƒ½ã€‚

##### Advisorsï¼ˆæ‹¦æˆªå™¨ï¼‰

è´£ä»»é“¾æ¨¡å¼çš„æ‹¦æˆªå™¨æœºåˆ¶ï¼Œåœ¨è°ƒç”¨å¤§æ¨¡å‹å‰åæ‰§è¡Œå¢å¼ºé€»è¾‘ï¼ˆå¦‚æ³¨å…¥å†å²å¯¹è¯ã€å®‰å…¨æ ¡éªŒï¼‰ã€‚é€šè¿‡ `getOrder()` æ§åˆ¶æ‰§è¡Œé¡ºåºï¼Œå¸¸ç”¨å¦‚ `MessageChatMemoryAdvisor`ï¼ˆå¯¹è¯è®°å¿†ï¼‰ã€`QuestionAnswerAdvisor`ï¼ˆçŸ¥è¯†æ£€ç´¢ï¼‰ã€‚

##### Chat Memory Advisor

è´Ÿè´£ç»´æŠ¤å¯¹è¯ä¸Šä¸‹æ–‡çš„æ‹¦æˆªå™¨ï¼Œå¸¸è§ï¼š

- **MessageChatMemoryAdvisor**ï¼šå°†å†å²æ¶ˆæ¯ä½œä¸ºç‹¬ç«‹è§’è‰²è®°å½•æ³¨å…¥ Promptï¼ˆä¿ç•™å®Œæ•´å¯¹è¯ç»“æ„ï¼‰ã€‚
- **PromptChatMemoryAdvisor**ï¼šå°†å†å²å¯¹è¯æ‹¼æ¥ä¸ºç³»ç»Ÿæç¤ºæ–‡æœ¬ï¼ˆå¯èƒ½ä¸¢å¤±æ¶ˆæ¯è¾¹ç•Œï¼‰ã€‚

##### Chat Memory

å¯¹è¯è®°å½•çš„å­˜å‚¨æ¥å£ï¼Œæä¾›ä¿å­˜/æŸ¥è¯¢/æ¸…ç©ºæ¶ˆæ¯çš„èƒ½åŠ›ï¼Œå†…ç½®å®ç°åŒ…æ‹¬ï¼š

- å†…å­˜å­˜å‚¨ï¼ˆ`InMemoryChatMemory`ï¼‰
- æŒä¹…åŒ–å­˜å‚¨ï¼ˆJDBCã€Cassandraã€Neo4j ç­‰ï¼‰
- å‘é‡æ•°æ®åº“æ‰©å±•ï¼ˆ`VectorStoreChatMemoryAdvisor` æ”¯æŒæ£€ç´¢å¢å¼ºï¼‰ã€‚

**å¼€å‘æµç¨‹**ï¼š
â‘  åˆ›å»º`ChatClient`å¹¶ç»‘å®šå¤§æ¨¡å‹
â‘¡ é…ç½®`MessageChatMemoryAdvisor`+é€‰æ‹©`ChatMemory`å®ç°
â‘¢ é€šè¿‡`.defaultAdvisors()`æ³¨å…¥è®°å¿†å¤„ç†é“¾
â‘£ å¯¹è¯æ—¶è‡ªåŠ¨æºå¸¦å†å²ä¸Šä¸‹æ–‡

- **æŠ€æœ¯æ ˆ**ï¼šSpring AI æ¡†æ¶ + `ChatClient` + `MessageChatMemoryAdvisor`ã€‚

- **æ ¸å¿ƒæœºåˆ¶**ï¼š

- å¯¹è¯å†å²è‡ªåŠ¨æ³¨å…¥æ¨¡å‹ä¸Šä¸‹æ–‡ï¼ˆä¿ç•™è§’è‰²æ ‡è¯†ï¼‰ã€‚

- å†…å­˜å­˜å‚¨ä¼šè¯æ•°æ®ï¼ˆæ”¯æŒæ›¿æ¢ä¸ºæ•°æ®åº“ï¼‰ã€‚

- **è°ƒç”¨ç¤ºä¾‹**ï¼š

- ```java
  ChatMemory chatMemory = new InMemoryChatMemory();
  chatClient = ChatClient.builder(dashscopeChatModel)
          .defaultSystem(SYSTEM_PROMPT)
          .defaultAdvisors(
                  new MessageChatMemoryAdvisor(chatMemory),
                  // è®°å½•æ—¥å¿—
                  new MyLoggerAdvisor(),
                  // è¿ç¦è¯æ£€æµ‹ - ä»æ–‡ä»¶è¯»å–è¿ç¦è¯
                  new ProhibitedWordAdvisor(),
                  // å¤è¯»å¼ºåŒ–é˜…è¯»èƒ½åŠ›
                  new ReReadingAdvisor()
                  )
          .build();

  ```

### å¤šè½®å¯¹è¯ AI åº”ç”¨å¼€å‘

**LoveAppçš„å¼€å‘**

```java
package com.yuan.yuanaiagent.app;

import com.yuan.yuanaiagent.advisor.MyLoggerAdvisor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.chat.client.advisor.MessageChatMemoryAdvisor;
import org.springframework.ai.chat.memory.ChatMemory;
import org.springframework.ai.chat.memory.InMemoryChatMemoryRepository;
import org.springframework.ai.chat.memory.MessageWindowChatMemory;
import org.springframework.ai.chat.model.ChatModel;
import org.springframework.ai.chat.model.ChatResponse;
import org.springframework.stereotype.Component;

@Component
@Slf4j
public class LoveApp {

    private final ChatClient chatClient;

    private static final String SYSTEM_PROMPT = "æ‰®æ¼”æ·±è€•æ‹çˆ±å¿ƒç†é¢†åŸŸçš„ä¸“å®¶ã€‚å¼€åœºå‘ç”¨æˆ·è¡¨æ˜èº«ä»½ï¼Œå‘ŠçŸ¥ç”¨æˆ·å¯å€¾è¯‰æ‹çˆ±éš¾é¢˜ã€‚" +
            "å›´ç»•å•èº«ã€æ‹çˆ±ã€å·²å©šä¸‰ç§çŠ¶æ€æé—®ï¼šå•èº«çŠ¶æ€è¯¢é—®ç¤¾äº¤åœˆæ‹“å±•åŠè¿½æ±‚å¿ƒä»ªå¯¹è±¡çš„å›°æ‰°ï¼›" +
            "æ‹çˆ±çŠ¶æ€è¯¢é—®æ²Ÿé€šã€ä¹ æƒ¯å·®å¼‚å¼•å‘çš„çŸ›ç›¾ï¼›å·²å©šçŠ¶æ€è¯¢é—®å®¶åº­è´£ä»»ä¸äº²å±å…³ç³»å¤„ç†çš„é—®é¢˜ã€‚" +
            "å¼•å¯¼ç”¨æˆ·è¯¦è¿°äº‹æƒ…ç»è¿‡ã€å¯¹æ–¹ååº”åŠè‡ªèº«æƒ³æ³•ï¼Œä»¥ä¾¿ç»™å‡ºä¸“å±è§£å†³æ–¹æ¡ˆã€‚";

    /**
     * åˆå§‹åŒ– ChatClient
     *
     * @param dashscopeChatModel
     */
    public LoveApp(ChatModel dashscopeChatModel) {
        // 1. åˆ›å»ºèŠå¤©è®°å¿†
        MessageWindowChatMemory chatMemory = MessageWindowChatMemory.builder()
                // å­˜å‚¨ä½ç½®
                .chatMemoryRepository(new InMemoryChatMemoryRepository())
                // å®¹é‡é™åˆ¶
                .maxMessages(20)
                .build();
        // 2. æ„å»ºèŠå¤©å®¢æˆ·ç«¯
        chatClient = ChatClient.builder(dashscopeChatModel)
                // ç³»ç»Ÿæç¤ºè¯
                .defaultSystem(SYSTEM_PROMPT)
                // é¡¾é—®ï¼ˆæ‹¦æˆªå™¨ï¼‰é“¾
                .defaultAdvisors(
                        MessageChatMemoryAdvisor.builder(chatMemory).build(),
                        new MyLoggerAdvisor()
                )
                .build();

    }

    /**
     * AI åŸºç¡€å¯¹è¯ï¼ˆæ”¯æŒå¤šè½®å¯¹è¯è®°å¿†ï¼‰
     *
     * @param message
     * @param chatId
     * @return
     */
    public String doChat(String message, String chatId) {
        ChatResponse chatResponse = chatClient.prompt()
                .user(message)
                .advisors(spec -> spec.param(ChatMemory.CONVERSATION_ID, chatId))
                .call()
                .chatResponse();
        String content = chatResponse.getResult().getOutput().getText();
        log.info("content: {}", content);
        return content;
    }
}
```

### æ‰©å±•çŸ¥è¯†è¡¥å……

**è‡ªå®šä¹‰Advisor**

**æ—¥å¿—è®°å½•å·¥å…·**

```java
package com.yuan.yuanaiagent.advisor;

import lombok.extern.slf4j.Slf4j;
import org.springframework.ai.chat.client.ChatClientMessageAggregator;
import org.springframework.ai.chat.client.ChatClientRequest;
import org.springframework.ai.chat.client.ChatClientResponse;
import org.springframework.ai.chat.client.advisor.api.CallAdvisor;
import org.springframework.ai.chat.client.advisor.api.CallAdvisorChain;
import org.springframework.ai.chat.client.advisor.api.StreamAdvisor;
import org.springframework.ai.chat.client.advisor.api.StreamAdvisorChain;
import reactor.core.publisher.Flux;

/**
 * è‡ªå®šä¹‰æ—¥å¿— Advisorï¼Œæ‰“å°ç”¨æˆ·è¾“å…¥å’Œ AI è¾“å‡º
 */
@Slf4j
public class MyLoggerAdvisor implements CallAdvisor, StreamAdvisor {
    /**
     * åŒæ­¥è°ƒç”¨å¤„ç†
     * @param chatClientRequest
     * @param callAdvisorChain
     * @return
     */
    @Override
    public ChatClientResponse adviseCall(ChatClientRequest chatClientRequest, CallAdvisorChain callAdvisorChain) {
        // 1. è®°å½•è¯·æ±‚æ—¥å¿—
        chatClientRequest = before(chatClientRequest);
        // 2. æ‰§è¡Œå®é™…è°ƒç”¨
        ChatClientResponse chatClientResponse = callAdvisorChain.nextCall(chatClientRequest);
        // 3. è®°å½•å“åº”æ—¥å¿—
        observeAfter(chatClientResponse);
        // 4. è¿”å›å“åº”
        return chatClientResponse;
    }

    /**
     * æµå¼è°ƒç”¨å¤„ç†
     * @param chatClientRequest
     * @param streamAdvisorChain
     * @return
     */
    @Override
    public Flux<ChatClientResponse> adviseStream(ChatClientRequest chatClientRequest, StreamAdvisorChain streamAdvisorChain) {
        // 1. è®°å½•è¯·æ±‚æ—¥å¿—
        chatClientRequest = before(chatClientRequest);
        // 2. è·å–æµå¼å“åº”
        Flux<ChatClientResponse> chatClientResponseFlux = streamAdvisorChain.nextStream(chatClientRequest);
        // 3. èšåˆæµå¼å“åº”å¹¶è®°å½•
        return new ChatClientMessageAggregator().aggregateChatClientResponse(chatClientResponseFlux, this::observeAfter);
    }

    @Override
    public String getName() {
        return this.getClass().getSimpleName();
    }

    /**
     * é¡ºåºï¼Œæ•°å­—è¶Šå°è¶Šå…ˆæ‰§è¡Œ
     * @return
     */
    @Override
    public int getOrder() {
        return 0;
    }

    /**
     * è¯·æ±‚å‰æ‰“å°ç”¨æˆ·è¾“å…¥
     * @param request
     * @return
     */
    private ChatClientRequest before(ChatClientRequest request) {
        log.info("AI Request: {}", request.prompt());
        return request;
    }

    /**
     * å“åº”åæ‰“å° AI è¾“å‡º
     * @param response
     */
    private void observeAfter(ChatClientResponse response) {
        log.info("AI Response: {}", response.chatResponse().getResult().getOutput().getText());
    }
}
```

**testChatæµ‹è¯•ä»£ç **

```java
@Test
public void testChat() {
    String chatId = UUID.randomUUID().toString();
    // ç¬¬ä¸€è½®
    String message = "ä½ å¥½ï¼Œæˆ‘æ˜¯é˜¿æº";
    String answer = loveApp.doChat(message, chatId);
    // ç¬¬äºŒè½®
    message = "æˆ‘æƒ³è®©å¦ä¸€åŠï¼ˆé˜¿æ©™ï¼‰æ›´çˆ±æˆ‘";
    answer = loveApp.doChat(message, chatId);
    Assertions.assertNotNull(answer);
    // ç¬¬ä¸‰è½®
    message = "æˆ‘çš„å¦ä¸€åŠå«ä»€ä¹ˆæ¥ç€ï¼Ÿåˆšè·Ÿä½ è¯´è¿‡ï¼Œå¸®æˆ‘å›å¿†ä¸€ä¸‹";
    answer = loveApp.doChat(message, chatId);
    Assertions.assertNotNull(answer);
}
```

**æµ‹è¯•ç»“æœ**

![](./img/pic3.png)

![](./img/pic4.png)

**è¿ç¦è¯å·¥å…·**

```java
package com.yuan.yuanaiagent.advisor;

import lombok.extern.slf4j.Slf4j;
import org.springframework.ai.chat.client.ChatClientRequest;
import org.springframework.ai.chat.client.ChatClientResponse;
import org.springframework.ai.chat.client.advisor.api.CallAdvisor;
import org.springframework.ai.chat.client.advisor.api.CallAdvisorChain;
import org.springframework.ai.chat.client.advisor.api.StreamAdvisor;
import org.springframework.ai.chat.client.advisor.api.StreamAdvisorChain;
import org.springframework.core.io.ClassPathResource;
import org.springframework.util.StringUtils;
import reactor.core.publisher.Flux;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.nio.charset.StandardCharsets;
import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

/**
 * è¿ç¦è¯æ ¡éªŒ Advisor
 * æ£€æŸ¥ç”¨æˆ·è¾“å…¥æ˜¯å¦åŒ…å«è¿ç¦è¯
 */
@Slf4j
public class ProhibitedWordAdvisor implements CallAdvisor, StreamAdvisor {

    private static final String DEFAULT_PROHIBITED_WORDS_FILE = "prohibited-words.txt";
    private final List<String> prohibitedWords;

    /**
     * åˆ›å»ºé»˜è®¤è¿ç¦è¯Advisorï¼Œä»é»˜è®¤æ–‡ä»¶è¯»å–è¿ç¦è¯åˆ—è¡¨
     */
    public ProhibitedWordAdvisor() {
        this.prohibitedWords = loadProhibitedWordsFromFile(DEFAULT_PROHIBITED_WORDS_FILE);
        log.info("åˆå§‹åŒ–è¿ç¦è¯Advisorï¼Œè¿ç¦è¯æ•°é‡: {}", prohibitedWords.size());
    }

    /**
     * åˆ›å»ºè¿ç¦è¯Advisorï¼Œä»æŒ‡å®šæ–‡ä»¶è¯»å–è¿ç¦è¯åˆ—è¡¨
     */
    public ProhibitedWordAdvisor(String prohibitedWordsFile) {
        this.prohibitedWords = loadProhibitedWordsFromFile(prohibitedWordsFile);
        log.info("åˆå§‹åŒ–è¿ç¦è¯Advisorï¼Œè¿ç¦è¯æ•°é‡: {}", prohibitedWords.size());
    }

    /**
     * ä»æ–‡ä»¶åŠ è½½è¿ç¦è¯åˆ—è¡¨
     */
    private List<String> loadProhibitedWordsFromFile(String filePath) {
        try {
            var resource = new ClassPathResource(filePath);
            var reader = new BufferedReader(
                    new InputStreamReader(resource.getInputStream(), StandardCharsets.UTF_8)
            );

            List<String> words = reader.lines()
                    .filter(StringUtils::hasText)
                    .map(String::trim)
                    .collect(Collectors.toList());

            log.info("ä»æ–‡ä»¶ {} åŠ è½½è¿ç¦è¯ {} ä¸ª", filePath, words.size());
            return words;
        } catch (IOException e) {
            log.error("åŠ è½½è¿ç¦è¯æ–‡ä»¶ {} å¤±è´¥", filePath, e);
            return new ArrayList<>();
        }
    }

    /**
     * æ£€æŸ¥è¯·æ±‚ä¸­æ˜¯å¦åŒ…å«è¿ç¦è¯
     */
    public ChatClientRequest checkRequest(ChatClientRequest request) {
        String userText = request.prompt().getUserMessage().getText();
        if (containsProhibitedWord(userText)) {
            log.warn("æ£€æµ‹åˆ°è¿ç¦è¯åœ¨ç”¨æˆ·è¾“å…¥ä¸­: {}", userText);
            throw new ProhibitedWordException("ç”¨æˆ·è¾“å…¥åŒ…å«è¿ç¦è¯");
        }
        return request;
    }

    /**
     * æ£€æŸ¥æ–‡æœ¬ä¸­æ˜¯å¦åŒ…å«è¿ç¦è¯
     */
    public boolean containsProhibitedWord(String text) {
        if (!StringUtils.hasText(text)) {
            return false;
        }

        for (String word : prohibitedWords) {
            if (text.toLowerCase().contains(word.toLowerCase())) {
                return true;
            }
        }
        return false;
    }

    @Override
    public ChatClientResponse adviseCall(ChatClientRequest chatClientRequest, CallAdvisorChain callAdvisorChain) {
        ChatClientRequest request = checkRequest(chatClientRequest);
        return callAdvisorChain.nextCall(request);
    }

    @Override
    public Flux<ChatClientResponse> adviseStream(ChatClientRequest chatClientRequest, StreamAdvisorChain streamAdvisorChain) {
        ChatClientRequest request = checkRequest(chatClientRequest);
        return streamAdvisorChain.nextStream(request);
    }

    @Override
    public String getName() {
        return this.getClass().getSimpleName();
    }

    /**
     * ç¡®ä¿åœ¨å…¶ä»–Advisorä¹‹å‰æ‰§è¡Œ
     *
     * @return
     */
    @Override
    public int getOrder() {
        return -100;
    }

    /**
     * è¿ç¦è¯å¼‚å¸¸
     */
    public static class ProhibitedWordException extends RuntimeException {
        public ProhibitedWordException(String message) {
            super(message);
        }
    }
}
```

**æµ‹è¯•å¦‚å›¾**

![](./img/pic5.png)

![](./img/pic6.png)

**æé«˜ AI æ¨ç†èƒ½åŠ› Advisor**

**ä¸ºä»€ä¹ˆè¿™ä¹ˆåš**

è¿™æ˜¯ä¸€ç§ **æç¤ºå·¥ç¨‹ï¼ˆPrompt Engineeringï¼‰æŠ€å·§**ï¼Œç›®çš„åŒ…æ‹¬ï¼š

1. **å¼ºè°ƒé—®é¢˜**ï¼šé€šè¿‡é‡å¤é—®é¢˜ï¼Œè®©æ¨¡å‹æ›´èšç„¦ï¼Œå‡å°‘è·‘é¢˜ã€‚
2. **å¯¹æŠ—å¹»è§‰**ï¼šæé†’æ¨¡å‹â€œä»”ç»†çœ‹é—®é¢˜â€ï¼Œé™ä½ç¼–é€ ç­”æ¡ˆçš„æ¦‚ç‡ã€‚
3. **ç»“æ„åŒ–è¾“å…¥**ï¼šä¸ºåç»­é“¾å¼æ¨ç†ï¼ˆå¦‚ ReActã€self-askï¼‰åšå‡†å¤‡ã€‚
4. **æ ‡å‡†åŒ–è¾“å…¥æ ¼å¼**ï¼šæ— è®ºç”¨æˆ·æ€ä¹ˆé—®ï¼Œéƒ½ç»Ÿä¸€æˆâ€œé—®é¢˜ + é‡è¯»é—®é¢˜â€çš„æ ¼å¼ã€‚

```java
package com.yuan.yuanaiagent.advisor;

import lombok.extern.slf4j.Slf4j;
import org.springframework.ai.chat.client.ChatClientRequest;
import org.springframework.ai.chat.client.ChatClientResponse;
import org.springframework.ai.chat.client.advisor.api.CallAdvisor;
import org.springframework.ai.chat.client.advisor.api.CallAdvisorChain;
import org.springframework.ai.chat.client.advisor.api.StreamAdvisor;
import org.springframework.ai.chat.client.advisor.api.StreamAdvisorChain;
import org.springframework.ai.chat.prompt.Prompt;
import org.springframework.ai.chat.prompt.PromptTemplate;
import reactor.core.publisher.Flux;

import java.util.HashMap;
import java.util.Map;

/**
 * è‡ªå®šä¹‰ Re2 Advisor
 * å¯æé«˜å¤§å‹è¯­è¨€æ¨¡å‹çš„æ¨ç†èƒ½åŠ›
 */
@Slf4j
public class ReReadingAdvisor implements CallAdvisor, StreamAdvisor {

    /**
     * æ‰§è¡Œè¯·æ±‚å‰ï¼Œæ”¹å†™ Prompt
     *
     * @param request
     * @return
     */
    private ChatClientRequest before(ChatClientRequest request) {
        Map<String, Object> advisorUserParams = new HashMap<>(request.prompt().getUserMessage().getMetadata());
        advisorUserParams.put("re2_input_query", request.prompt().getUserMessage().getText());
        // æ„å»ºæç¤ºè¯æ¨¡æ¿
        String template = """
                {re2_input_query}
                Read the question again: {re2_input_query}
                """;
        // æ„å»ºæç¤ºè¯
        Prompt prompt = PromptTemplate.builder()
                .template(template)
                .build()
                .create(advisorUserParams);
        log.info("æ”¹å†™åçš„ Prompt: {}", prompt);
        return ChatClientRequest.builder()
                .prompt(prompt)
                .build();
    }

    @Override
    public ChatClientResponse adviseCall(ChatClientRequest chatClientRequest, CallAdvisorChain callAdvisorChain) {
        return callAdvisorChain.nextCall(before(chatClientRequest));
    }

    @Override
    public Flux<ChatClientResponse> adviseStream(ChatClientRequest chatClientRequest, StreamAdvisorChain streamAdvisorChain) {
        return streamAdvisorChain.nextStream(before(chatClientRequest));
    }

    @Override
    public String getName() {
        return this.getClass().getSimpleName();
    }

    @Override
    public int getOrder() {
        return 0;
    }
}
```

**æµ‹è¯•å¦‚å›¾**

![](./img/pic7.png)

**ç»“æ„åŒ–è¾“å‡º - æ‹çˆ±æŠ¥å‘ŠåŠŸèƒ½å¼€å‘**

```java
/**
 * AI æ‹çˆ±æŠ¥å‘ŠåŠŸèƒ½ï¼ˆå®æˆ˜ç»“æ„åŒ–è¾“å‡ºï¼‰
 *
 * @param message
 * @param chatId
 * @return
 */
public LoveReport doChatWithReport(String message, String chatId) {
    LoveReport loveReport = chatClient
            .prompt()
            .system(SYSTEM_PROMPT + "æ¯æ¬¡å¯¹è¯åéƒ½è¦ç”Ÿæˆæ‹çˆ±ç»“æœï¼Œæ ‡é¢˜ä¸º{ç”¨æˆ·å}çš„æ‹çˆ±æŠ¥å‘Šï¼Œå†…å®¹ä¸ºå»ºè®®åˆ—è¡¨")
            .user(message)
            .advisors(spec -> spec.param(ChatMemory.CONVERSATION_ID, chatId))
            .call()
            .entity(LoveReport.class);
    log.info("loveReport: {}", loveReport);
    return loveReport;
}
```

```java
@Test
void doChatWithReport() {
    String chatId = UUID.randomUUID().toString();
    String message = "ä½ å¥½ï¼Œæˆ‘æ˜¯ç¨‹åºå‘˜é˜¿æºï¼Œæˆ‘æƒ³è®©å¦ä¸€åŠï¼ˆé˜¿æ©™ï¼‰æ›´çˆ±æˆ‘ï¼Œä½†æˆ‘ä¸çŸ¥é“è¯¥æ€ä¹ˆåš";
    LoveApp.LoveReport loveReport = loveApp.doChatWithReport(message, chatId);
    Assertions.assertNotNull(loveReport);
}
```

**æ³¨æ„ï¼éœ€è¦å¼•å…¥ä¾èµ–**

`com.github.victools:jsonschema-generator` æ˜¯ä¸€ä¸ª **Java åº“**ï¼Œç”¨äºä» Java ç±»ï¼ˆå¦‚ POJOï¼‰**è‡ªåŠ¨ç”Ÿæˆ JSON Schema**ï¼ˆJSON ç»“æ„æè¿°ï¼‰ã€‚å®ƒåœ¨éœ€è¦**ç»“æ„åŒ–è¾“å‡ºï¼ˆStructured Outputï¼‰**çš„åœºæ™¯ä¸­éå¸¸æœ‰ç”¨ï¼Œå°¤å…¶æ˜¯åœ¨ä¸å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰é›†æˆæ—¶ï¼Œç”¨æ¥çº¦æŸæ¨¡å‹è¾“å‡ºä¸ºæŒ‡å®šçš„ JSON æ ¼å¼ã€‚

```xml
<!-- æ”¯æŒç»“æ„åŒ–è¾“å‡º -->
<dependency>
    <groupId>com.github.victools</groupId>
    <artifactId>jsonschema-generator</artifactId>
    <version>4.38.0</version>
</dependency>
```

![](./img/pic8.png)

**å¯¹è¯è®°å¿†æŒä¹…åŒ–**

**kryo æ–‡ä»¶è¯»å–æŒä¹…åŒ–**

`com.esotericsoftware:kryo` æ˜¯ä¸€ä¸ª **é«˜æ€§èƒ½ã€é«˜æ•ˆçš„ Java å¯¹è±¡åºåˆ—åŒ–/ååºåˆ—åŒ–åº“**ï¼Œå¸¸ç”¨äºéœ€è¦å°†å¯¹è±¡è½¬æ¢ä¸ºå­—èŠ‚æµï¼ˆä¾‹å¦‚ä¿å­˜åˆ°æ–‡ä»¶ã€ç½‘ç»œä¼ è¾“ã€ç¼“å­˜ç­‰ï¼‰çš„åœºæ™¯ã€‚

ä½ åœ¨æ³¨é‡Šä¸­æåˆ°ï¼š

> `<!-- æ”¯æŒæ–‡ä»¶ä¼šè¯è®°å¿†æŒä¹…åŒ–çš„åºåˆ—åŒ– -->`

è¿™éå¸¸å‡†ç¡® â€”â€” **Kryo å¸¸è¢«ç”¨äºå°†ä¼šè¯çŠ¶æ€ï¼ˆå¦‚èŠå¤©å†å²ã€ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼‰åºåˆ—åŒ–åæŒä¹…åŒ–åˆ°ç£ç›˜æˆ–æ•°æ®åº“ä¸­ï¼Œä»¥ä¾¿åç»­æ¢å¤**ï¼Œå°¤å…¶åœ¨ AI åº”ç”¨ã€æ¸¸æˆæœåŠ¡å™¨ã€åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¾ˆå¸¸è§ã€‚

```xml
<!-- æ”¯æŒæ–‡ä»¶ä¼šè¯è®°å¿†æŒä¹…åŒ–çš„åºåˆ—åŒ– -->
<dependency>
    <groupId>com.esotericsoftware</groupId>
    <artifactId>kryo</artifactId>
    <version>5.6.2</version>
</dependency>
```

```java
package com.yuan.yuanaiagent.chatmemory;

import com.esotericsoftware.kryo.Kryo;
import com.esotericsoftware.kryo.io.Input;
import com.esotericsoftware.kryo.io.Output;
import org.objenesis.strategy.StdInstantiatorStrategy;
import org.springframework.ai.chat.memory.ChatMemory;
import org.springframework.ai.chat.messages.Message;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

/**
 * åŸºäºæ–‡ä»¶æŒä¹…åŒ–çš„å¯¹è¯è®°å¿†
 */
public class FileBasedChatMemory implements ChatMemory {

    private final String BASE_DIR;

    private static final Kryo kryo = new Kryo();

    static {
        /**
         * å…³é—­â€œç±»å¿…é¡»æ˜¾å¼æ³¨å†Œâ€çš„é™åˆ¶ã€‚
         * ğŸ”¸ èƒŒæ™¯ï¼š
         * Kryo é»˜è®¤è¦æ±‚ï¼šæ‰€æœ‰è¦åºåˆ—åŒ–çš„ç±»å¿…é¡»é€šè¿‡ kryo.register(SomeClass.class) æ˜¾å¼æ³¨å†Œã€‚
         * è¿™æ˜¯ä¸ºäº†æå‡æ€§èƒ½ï¼ˆé¿å…è¿è¡Œæ—¶åå°„æŸ¥ç±»åï¼‰å’Œå®‰å…¨æ€§ï¼ˆé˜²æ­¢ååºåˆ—åŒ–ä»»æ„ç±»ï¼‰ã€‚
         * ğŸ”¸ è®¾ç½®ä¸º false åï¼š
         * Kryo å¯ä»¥è‡ªåŠ¨å¤„ç†æœªæ³¨å†Œçš„ç±»ï¼ˆé€šè¿‡ç±»åå†™å…¥å­—èŠ‚æµï¼‰ã€‚
         * ä½¿ç”¨æ›´æ–¹ä¾¿ï¼ˆæ— éœ€æå‰çŸ¥é“æ‰€æœ‰ç±»å‹ï¼‰ï¼Œä½†ï¼š
         * æ€§èƒ½ç•¥ä½ï¼ˆéœ€å†™å…¥å®Œæ•´ç±»åï¼Œå¦‚ com.example.Userï¼‰ï¼›
         * ä½“ç§¯ç•¥å¤§ï¼ˆç±»åå ç©ºé—´ï¼‰ï¼›
         * å®‰å…¨æ€§é™ä½ï¼ˆå¯èƒ½ååºåˆ—åŒ–æ¶æ„ç±»ï¼Œéœ€ç¡®ä¿æ•°æ®å¯ä¿¡ï¼‰ã€‚
         */
        kryo.setRegistrationRequired(false);
        /**
         * ğŸ”¹ ä½œç”¨ï¼š
         * æŒ‡å®šå¯¹è±¡ååºåˆ—åŒ–æ—¶çš„å®ä¾‹åŒ–ç­–ç•¥ â€”â€” ä½¿ç”¨ä¸è°ƒç”¨æ„é€ å‡½æ•°çš„æ–¹å¼åˆ›å»ºå¯¹è±¡ã€‚
         * ğŸ”¸ èƒŒæ™¯ï¼š
         * Java å¯¹è±¡é€šå¸¸é€šè¿‡ new è°ƒç”¨æ„é€ å‡½æ•°åˆ›å»ºã€‚
         * ä½†æŸäº›ç±»æ²¡æœ‰æ— å‚æ„é€ å‡½æ•°ï¼Œæˆ–æ„é€ å‡½æ•°æœ‰å‰¯ä½œç”¨ï¼ˆå¦‚åˆå§‹åŒ–ç½‘ç»œè¿æ¥ï¼‰ï¼Œå¯¼è‡´ Kryo æ— æ³•ååºåˆ—åŒ–ã€‚
         * ğŸ”¸ StdInstantiatorStrategy æ˜¯ä»€ä¹ˆï¼Ÿ
         * æ¥è‡ª objenesis åº“ï¼ˆKryo ä¾èµ–å®ƒï¼‰ï¼›
         * ä½¿ç”¨åº•å±‚ JVM æŠ€æœ¯ï¼ˆå¦‚ sun.misc.Unsafe æˆ– ObjectInputStreamï¼‰ç»•è¿‡æ„é€ å‡½æ•°ç›´æ¥åˆ†é…å†…å­˜å¹¶åˆ›å»ºå¯¹è±¡ï¼›
         * ç±»ä¼¼äº Java åŸç”Ÿåºåˆ—åŒ–çš„è¡Œä¸ºã€‚
         */
        kryo.setInstantiatorStrategy(new StdInstantiatorStrategy());
    }

    // æ„é€ å¯¹è±¡æ—¶ï¼ŒæŒ‡å®šæ–‡ä»¶ä¿å­˜ç›®å½•
    public FileBasedChatMemory(String dir) {
        this.BASE_DIR = dir;
        File file = new File(dir);
        if (!file.exists()) {
            file.mkdirs();
        }
    }

    @Override
    public void add(String conversationId, List<Message> messages) {
        List<Message> conversationMessages = getOrCreateConversation(conversationId);
        conversationMessages.addAll(messages);
        saveConversation(conversationId, conversationMessages);
    }

    @Override
    public List<Message> get(String conversationId) {
        return getOrCreateConversation(conversationId);
    }

    @Override
    public void clear(String conversationId) {
        File file = getConversationFile(conversationId);
        if (file.exists()) {
            file.delete();
        }
    }

    private List<Message> getOrCreateConversation(String conversationId) {
        File file = getConversationFile(conversationId);
        List<Message> messages = new ArrayList<>();
        if (file.exists()) {
            try (Input input = new Input(new FileInputStream(file))) {
                messages = kryo.readObject(input, ArrayList.class);
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
        return messages;
    }

    private void saveConversation(String conversationId, List<Message> messages) {
        File file = getConversationFile(conversationId);
        try (Output output = new Output(new FileOutputStream(file))) {
            kryo.writeObject(output, messages);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    private File getConversationFile(String conversationId) {
        return new File(BASE_DIR, conversationId + ".kryo");
    }
}
```

```java
/**
 * åˆå§‹åŒ– ChatClient
 *
 * @param dashscopeChatModel
 */
public LoveApp(ChatModel dashscopeChatModel) {
    // 1. åˆ›å»ºèŠå¤©è®°å¿†

    // åˆå§‹åŒ–åŸºäºæ–‡ä»¶çš„å¯¹è¯è®°å¿†
    String fileDir = System.getProperty("user.dir") + "/tmp/chat-memory";
    ChatMemory chatMemory = new FileBasedChatMemory(fileDir);

//    // åˆå§‹åŒ–åŸºäºæ–‡ä»¶çš„å¯¹è¯è®°å¿†
//    MessageWindowChatMemory chatMemory = MessageWindowChatMemory.builder()
//            // å­˜å‚¨ä½ç½®
//            .chatMemoryRepository(new InMemoryChatMemoryRepository())
//            // å®¹é‡é™åˆ¶
//            .maxMessages(20)
//            .build();
    // 2. æ„å»ºèŠå¤©å®¢æˆ·ç«¯
    chatClient = ChatClient.builder(dashscopeChatModel)
            // ç³»ç»Ÿæç¤ºè¯
            .defaultSystem(SYSTEM_PROMPT)
            // é¡¾é—®ï¼ˆæ‹¦æˆªå™¨ï¼‰é“¾
            .defaultAdvisors(
                    MessageChatMemoryAdvisor.builder(chatMemory).build(),
                    // è®°å½•æ—¥å¿—
                      new MyLoggerAdvisor()
                    // è¿ç¦è¯æ£€æµ‹ - ä»æ–‡ä»¶è¯»å–è¿ç¦è¯
//                      new ProhibitedWordAdvisor()
                    // æ‰§è¡Œè¯·æ±‚å‰ï¼Œæ”¹å†™ Prompt
//                    new ReReadingAdvisor()
            )
            .build();
}
```

**æµ‹è¯•å¦‚å›¾**

![](./img/pic9.png)

**æ•°æ®åº“æŒä¹…åŒ–**

```sql
-- åˆ›å»ºæ•°æ®åº“ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
CREATE DATABASE IF NOT EXISTS yuan CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- ä½¿ç”¨æ•°æ®åº“
USE yuan;

-- åˆ›å»ºå¯¹è¯è®°å¿†è¡¨
CREATE TABLE IF NOT EXISTS chatmemory
(
    id              BIGINT AUTO_INCREMENT PRIMARY KEY,
    conversation_id VARCHAR(255) NOT NULL,
    message_order   INT          NOT NULL,
    message_type    VARCHAR(50)  NOT NULL,
    content         TEXT         NOT NULL,
    message_json    TEXT         NOT NULL,
    create_time     TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time     TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    is_delete       BOOLEAN   DEFAULT 0,
    INDEX idx_conversation_id (conversation_id),
    INDEX idx_conversation_order (conversation_id, message_order),
    INDEX idx_is_delete (is_delete)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci;
```

**MyBatis-Plus æ¡†æ¶æŒä¹…åŒ–**

**é¦–å…ˆæ ¹æ® MyBatis-Plus ç”Ÿæˆ ç›¸å…³æ–‡ä»¶**

![](./img/pic10.png)

![](./img/pic11.png)

**yamlé…ç½®**

```xml
spring:
  # æ•°æ®åº“é…ç½®
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/yuan?useSSL=false&allowPublicKeyRetrieval=true&useUnicode=true&characterEncoding=UTF-8&serverTimezone=Asia/Shanghai
    username: root
    password: 2003dhy0915

# MP é…ç½®
mybatis-plus:
  configuration:
    map-underscore-to-camel-case: true
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
  global-config:
    db-config:
      logic-delete-field: isDelete # å…¨å±€é€»è¾‘åˆ é™¤çš„å®ä½“å­—æ®µå
      logic-delete-value: 1 # é€»è¾‘å·²åˆ é™¤å€¼ï¼ˆé»˜è®¤ä¸º 1ï¼‰
      logic-not-delete-value: 0 # é€»è¾‘æœªåˆ é™¤å€¼ï¼ˆé»˜è®¤ä¸º 0ï¼‰
```

**å®ä½“ç±»**

```java
package com.yuan.yuanaiagent.domain;

import com.baomidou.mybatisplus.annotation.*;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.io.Serializable;
import java.util.Date;

/**
 * èŠå¤©è®°å¿†å®ä½“ç±»
 *
 * @TableName chatmemory
 */
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
@TableName(value = "chat_memory")
public class ChatMemory implements Serializable {
    /**
     * ä¸»é”®ID
     */
    @TableId(value = "id", type = IdType.AUTO)
    private Long id;

    /**
     * ä¼šè¯ID
     */
    @TableField(value = "conversation_id")
    private String conversationId;

    /**
     * æ¶ˆæ¯é¡ºåº
     */
    @TableField(value = "message_order")
    private Integer messageOrder;

    /**
     * æ¶ˆæ¯ç±»å‹
     */
    @TableField(value = "message_type")
    private String messageType;

    /**
     * æ¶ˆæ¯å†…å®¹
     */
    @TableField(value = "content")
    private String content;

    /**
     * æ¶ˆæ¯JSON
     */
    @TableField(value = "message_json")
    private String messageJson;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    @TableField(value = "create_time")
    private Date createTime;

    /**
     * æ›´æ–°æ—¶é—´
     */
    @TableField(value = "update_time")
    private Date updateTime;

    /**
     * æ˜¯å¦åˆ é™¤
     */
    @TableField(value = "is_delete")
    @TableLogic
    private Boolean isDelete;

    @TableField(exist = false)
    private static final long serialVersionUID = 1L;
}
```

**Service**

```java
package com.yuan.yuanaiagent.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.yuan.yuanaiagent.domain.ChatMemory;
import org.springframework.ai.chat.messages.Message;

import java.util.List;

/**
 * èŠå¤©è®°å¿†æœåŠ¡æ¥å£
 */
public interface ChatMemoryService extends IService<ChatMemory> {

    /**
     * æ·»åŠ å¤šæ¡æ¶ˆæ¯
     *
     * @param conversationId ä¼šè¯ID
     * @param messages       æ¶ˆæ¯åˆ—è¡¨
     */
    void addMessage(String conversationId, List<Message> messages);

    /**
     * è·å–ä¼šè¯æ¶ˆæ¯
     *
     * @param conversationId ä¼šè¯ID
     * @param lastN          è·å–çš„æ¶ˆæ¯æ•°é‡ï¼Œæ­£æ•°è¡¨ç¤ºè·å–å‰Næ¡ï¼Œ0æˆ–è´Ÿæ•°è¡¨ç¤ºè·å–å…¨éƒ¨
     * @return æ¶ˆæ¯åˆ—è¡¨
     */
    List<Message> getMessages(String conversationId, int lastN);

    /**
     * æ¸…é™¤ä¼šè¯æ¶ˆæ¯ï¼ˆé€»è¾‘åˆ é™¤ï¼‰
     *
     * @param conversationId ä¼šè¯ID
     */
    void clearMessages(String conversationId);
}
```

**Service å®ç°ç±»**

```java
package com.yuan.yuanaiagent.service.impl;

import cn.hutool.json.JSONConfig;
import cn.hutool.json.JSONUtil;
import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.yuan.yuanaiagent.domain.ChatMemory;
import com.yuan.yuanaiagent.mapper.ChatMemoryMapper;
import com.yuan.yuanaiagent.service.ChatMemoryService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.ai.chat.messages.AssistantMessage;
import org.springframework.ai.chat.messages.Message;
import org.springframework.ai.chat.messages.SystemMessage;
import org.springframework.ai.chat.messages.UserMessage;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.*;
import java.util.stream.Collectors;

/**
 * èŠå¤©è®°å¿†æœåŠ¡å®ç°ç±»
 */
@Service
@Slf4j
public class ChatMemoryServiceImpl extends ServiceImpl<ChatMemoryMapper, ChatMemory>
        implements ChatMemoryService {

    private final JSONConfig jsonConfig;

    public ChatMemoryServiceImpl() {
        this.jsonConfig = new JSONConfig().setIgnoreNullValue(true);
        log.info("åˆå§‹åŒ–Mybatis-PlusèŠå¤©è®°å¿†æœåŠ¡");
    }

    @Override
    @Transactional
    public void addMessages(String conversationId, List<Message> messages) {
        if (messages == null || messages.isEmpty() || conversationId == null) {
            return;
        }

        // è·å–å½“å‰æœ€å¤§åºå·
        Integer maxOrder = baseMapper.getMaxOrder(conversationId);
        int nextOrder = (maxOrder != null ? maxOrder : 0) + 1;

        // å°†SpringAIæ¶ˆæ¯è½¬æ¢ä¸ºå®ä½“
        List<ChatMemory> entities = new ArrayList<>();
        for (int i = 0; i < messages.size(); i++) {
            Message message = messages.get(i);
            int order = nextOrder + i;
            ChatMemory entity = ChatMemory.builder()
                    .conversationId(conversationId)
                    .messageOrder(order)
                    .messageType(message.getMessageType().toString())
                    .content(message.getText())
                    .messageJson(serializeMessage(message))
                    .createTime(new Date())
                    .updateTime(new Date())
                    .isDelete(false)
                    .build();

            entities.add(entity);
        }
        // æ‰¹é‡ä¿å­˜
        saveBatch(entities);
        log.info("å·²æ·»åŠ  {} æ¡æ¶ˆæ¯åˆ°ä¼šè¯ {}", messages.size(), conversationId);
    }

    @Override
    public List<Message> getMessages(String conversationId, int lastN) {
        List<ChatMemory> entities;
        if (lastN > 0) {
            // è·å–æœ€è¿‘çš„Næ¡æ¶ˆæ¯
            entities = baseMapper.getLatestMessages(conversationId, lastN);
        } else {
            LambdaQueryWrapper<ChatMemory> wrapper = new LambdaQueryWrapper<>();
            wrapper.eq(ChatMemory::getConversationId, conversationId)
                    .eq(ChatMemory::getIsDelete, false)
                    .orderByDesc(ChatMemory::getMessageOrder);
            entities = list(wrapper);
        }

        // å°†å®ä½“è½¬æ¢ä¸ºSpringAIæ¶ˆæ¯
        List<Message> messages = convertToMessages(entities);
        log.info("å·²ä»ä¼šè¯ {} ä¸­æ£€ç´¢åˆ° {} æ¡æ¶ˆæ¯", conversationId, messages.size());
        return messages;
    }

    @Override
    @Transactional
    public void clearMessages(String conversationId) {
        // é€»è¾‘åˆ é™¤æ‰€æœ‰ä¼šè¯æ¶ˆæ¯
        int count = baseMapper.logicalDeleteByConversationId(conversationId);
        log.info("å·²ä»ä¼šè¯ {} ä¸­é€»è¾‘åˆ é™¤ {} æ¡æ¶ˆæ¯", conversationId, count);
    }

    /**
     * å°†æ¶ˆæ¯åºåˆ—åŒ–ä¸ºJSONå­—ç¬¦ä¸²
     */
    private String serializeMessage(Message message) {
        Map<String, Object> map = new HashMap<>();
        map.put("type", message.getMessageType().toString());
        map.put("text", message.getText());

        // æ·»åŠ æ¶ˆæ¯ç±»åï¼Œä¾¿äºååºåˆ—åŒ–
        if (message instanceof UserMessage) {
            map.put("messageClass", "UserMessage");
        } else if (message instanceof SystemMessage) {
            map.put("messageClass", "SystemMessage");
        } else if (message instanceof AssistantMessage) {
            map.put("messageClass", "AssistantMessage");
        } else {
            map.put("messageClass", "OtherMessage");
        }

        return JSONUtil.toJsonStr(map, jsonConfig);
    }

    /**
     * å°†å®ä½“åˆ—è¡¨è½¬æ¢ä¸ºSpringAIæ¶ˆæ¯åˆ—è¡¨
     */
    private List<Message> convertToMessages(List<ChatMemory> entities) {
        return entities.stream()
                .map(this::convertToMessage)
                .filter(Objects::nonNull)
                .collect(Collectors.toList());
    }

    /**
     * å°†å•ä¸ªå®ä½“è½¬æ¢ä¸ºSpringAIæ¶ˆæ¯
     */
    private Message convertToMessage(ChatMemory entity) {
        String messageType = entity.getMessageType();
        String content = entity.getContent();

        // åŸºäºæ¶ˆæ¯ç±»å‹åˆ›å»ºç›¸åº”çš„æ¶ˆæ¯å®ä¾‹
        switch (messageType) {
            case "USER":
                return new UserMessage(content);
            case "SYSTEM":
                return new SystemMessage(content);
            case "ASSISTANT":
                return new AssistantMessage(content);
            default:
                log.warn("æœªçŸ¥çš„æ¶ˆæ¯ç±»å‹: {}", messageType);
                return new AssistantMessage("æœªçŸ¥æ¶ˆæ¯ç±»å‹: " + content);
        }
    }
}
```

**Mapper æ•°æ®å±‚ï¼š**

```java
package com.yuan.yuanaiagent.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.yuan.yuanaiagent.domain.ChatMemory;
import org.apache.ibatis.annotations.Param;
import org.apache.ibatis.annotations.Select;
import org.apache.ibatis.annotations.Update;

import java.util.List;

/**
* @author 86159
* @description é’ˆå¯¹è¡¨ã€chat_memoryã€‘çš„æ•°æ®åº“æ“ä½œMapper
* @createDate 2026-01-11 08:09:51
* @Entity generator.domain.ChatMemory
*/
@Mapper
public interface ChatMemoryMapper extends BaseMapper<ChatMemory> {

    /**
     * è·å–æœ€å¤§æ¶ˆæ¯åºå·
     */
    @Select("SELECT MAX(message_order) FROM chat_memory WHERE conversation_id = #{conversationId} AND is_delete = 0")
    Integer getMaxOrder(@Param("conversationId") String conversationId);

    /**
     * è·å–ä¼šè¯æ¶ˆæ¯æ•°é‡
     */
    @Select("SELECT COUNT(*) FROM chat_memory WHERE conversation_id = #{conversationId} AND is_delete = 0")
    int getMessageCount(@Param("conversationId") String conversationId);

    /**
     * é€»è¾‘åˆ é™¤ä¼šè¯æ¶ˆæ¯
     */
    @Update("UPDATE chat_memory SET is_delete = 1, update_time = NOW() WHERE conversation_id = #{conversationId} AND is_delete = 0")
    int logicalDeleteByConversationId(@Param("conversationId") String conversationId);

    /**
     * è·å–æœ€è¿‘æ¶ˆæ¯ï¼ŒæŒ‰æ¶ˆæ¯é¡ºåºé™åº
     */
    @Select("SELECT * from chat_memory WHERE conversation_id = #{conversationId} AND is_delete = 0 ORDER BY message_order DESC LIMIT #{limit}")
    List<ChatMemory> getLatestMessages(@Param("conversationId") String conversationId, @Param("limit") int limit);

    /**
     * åˆ†é¡µè·å–æ¶ˆæ¯
     */
    @Select("SELECT * FROM chat_memory WHERE conversation_id = #{conversationId} AND is_delete = 0 ORDER BY message_order DESC " +
            "LIMIT #{pageSize} OFFSET #{offset}")
    List<ChatMemory> getMessagesPaginated(@Param("conversationId") String conversationId,
                                          @Param("pageSize") int pageSize, @Param("offset") int offset);

    @Select("SELECT * FROM chat_memory WHERE conversation_id = #{conversationId} AND is_delete = 0 ORDER BY message_order DESC " +
            "LIMIT #{limit} OFFSET #{offset}")
    List<ChatMemory> getMessagesWithOffset(@Param("conversationId") String conversationId, @Param("limit") int limit,
                                           @Param("offset") int offset);
}
```

**æœ€åç®€å•å®ç° MybatisPlusChatMemory**

```java
package com.yuan.yuanaiagent.chatmemory;


import com.yuan.yuanaiagent.service.ChatMemoryService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.ai.chat.memory.ChatMemory;
import org.springframework.ai.chat.messages.Message;

import java.util.List;

/**
 * åŸºäºMybatis-Pluså®ç°çš„å¯¹è¯è®°å¿†
 * ä½¿ç”¨ChatMemoryServiceè¿›è¡Œæ•°æ®åº“æ“ä½œ
 */
//todo æŒ‰éœ€æ‰“å¼€
//@Component
@Slf4j
public class MyBatisPlusChatMemory implements ChatMemory {

    private final ChatMemoryService chatMemoryService;

    public MyBatisPlusChatMemory(ChatMemoryService chatMemoryService) {
        this.chatMemoryService = chatMemoryService;
        log.info("åˆå§‹åŒ–Mybatis-Pluså¯¹è¯è®°å¿†");
    }

    @Override
    public void add(String conversationId, List<Message> messages) {
        chatMemoryService.addMessages(conversationId, messages);
    }

    @Override
    public List<Message> get(String conversationId) {
        return chatMemoryService.getMessages(conversationId, 0);
    }

    @Override
    public void clear(String conversationId) {
        chatMemoryService.clearMessages(conversationId);
    }
}
```

**æ›´æ¢ChatMemory**

```java
public LoveApp(ChatModel dashscopeChatModel, @Qualifier("myBatisPlusChatMemory") ChatMemory chatMemory) 
```

**æµ‹è¯•å¦‚å›¾**

![](./img/pic12.png)



## ç¬¬ä¸‰ç«  RAGçŸ¥è¯†åº“åŸºç¡€

**æœ¬ç« å­¦ä¹ ğŸ“š**

1ã€AIçŸ¥è¯†é—®ç­”éœ€æ±‚åˆ†æï¼šRAGæŠ€æœ¯æ•´åˆç§æœ‰çŸ¥è¯†åº“ï¼Œæä¾›ä¸ªæ€§åŒ–æ‹çˆ±å»ºè®®
2ã€RAGæ ¸å¿ƒæ¦‚å¿µï¼šæ£€ç´¢å¢å¼ºç”Ÿæˆï¼Œæå‡ç­”æ¡ˆå‡†ç¡®æ€§ï¼Œå‡å°‘æ¨¡å‹å¹»è§‰
3ã€[Spring](https://www.mianshiya.com/bank/1790683494127804418) AIæœ¬åœ°å®æˆ˜ï¼šæ–‡æ¡£å¤„ç†ã€å‘é‡å­˜å‚¨ä¸RAGé›†æˆå®ç°
4ã€äº‘çŸ¥è¯†åº“å¼€å‘ï¼šé˜¿é‡Œäº‘ç™¾ç‚¼å¹³å°éƒ¨ç½²ï¼Œç®€åŒ–RAGå…¨æµç¨‹ç®¡ç†

### AI çŸ¥è¯†é—®ç­”éœ€æ±‚åˆ†æ

**AIçŸ¥è¯†é—®ç­” åœ¨æ‹çˆ±å’¨è¯¢ä¸­é€šè¿‡RAGæŠ€æœ¯æ•´åˆç§æœ‰çŸ¥è¯†åº“ï¼ˆå¦‚è¯¾ç¨‹ã€æ¡ˆä¾‹ï¼‰ï¼Œæä¾›ä¸ªæ€§åŒ–å»ºè®®ï¼ˆå¦‚çŸ›ç›¾è§£å†³ã€è¯¾ç¨‹æ¨èï¼‰ï¼Œå®ç°ç²¾å‡†æœåŠ¡ä¸è¯¾ç¨‹å˜ç°é—­ç¯ï¼ŒåŒæ—¶æ”¯æŒç¤¾åŒºäº’åŠ¨å’ŒåŒ¹é…æœåŠ¡ï¼Œå¹³è¡¡ç”¨æˆ·ä½“éªŒä¸å•†ä¸šä»·å€¼**

### RAG æ¦‚å¿µï¼ˆé‡ç‚¹ï¼‰

#### ä»€ä¹ˆæ˜¯ RAGï¼Ÿ

æ¨è Bç«™è§†é¢‘ï¼š[20åˆ†é’Ÿé€Ÿæˆ RAG & å‘é‡æ•°æ®åº“æ ¸å¿ƒæ¦‚å¿µ ã€å°ç™½å­¦AIç³»åˆ— -1 ã€‘_å“”å“©å“”å“©_bilibili](https://www.bilibili.com/video/BV11zf6YyEnT/?share_source=copy_web&vd_source=f64346e5ced06752cd6189d73ddefc00)

![](./img/pic13.png)

**RAGï¼ˆRetrieval-Augmented Generationï¼Œæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰**

- RAGï¼ˆRetrieval-Augmented Generationï¼‰æ˜¯ä¸€ç§ç»“åˆæ£€ç´¢å’Œç”Ÿæˆçš„æŠ€æœ¯ï¼Œç”¨äºå¢å¼ºç”Ÿæˆæ¨¡å‹çš„è¡¨ç°ã€‚

1. **çŸ¥è¯†åº“å‡†å¤‡**ï¼šå°†æ–‡æ¡£åˆ‡æˆå°å—ï¼Œç”¨åµŒå…¥æ¨¡å‹è½¬åŒ–ä¸ºå‘é‡ï¼Œå­˜å‚¨åœ¨å‘é‡æ•°æ®åº“ä¸­ã€‚
2. **æŸ¥è¯¢å¤„ç†**ï¼šå°†ç”¨æˆ·æŸ¥è¯¢è½¬ä¸ºå‘é‡ï¼Œä»æ•°æ®åº“ä¸­æ£€ç´¢ Top K ä¸ªç›¸å…³æ–‡æœ¬å—ï¼Œå†ç»“åˆæŸ¥è¯¢è¾“å…¥ç”Ÿæˆæ¨¡å‹ï¼Œè¾“å‡ºç­”æ¡ˆã€‚

**ä¼˜ç‚¹**ï¼šæå‡ç­”æ¡ˆå‡†ç¡®æ€§ï¼Œå‡å°‘ç”Ÿæˆâ€œå¹»è§‰â€ã€‚
**æŒ‘æˆ˜**ï¼šæ•ˆæœä¾èµ–åµŒå…¥æ¨¡å‹è´¨é‡å’ŒçŸ¥è¯†åº“è¦†ç›–èŒƒå›´ã€‚

**ç¬¬ä¸€**ï¼ŒæŠŠæ–‡æ¡£åˆ‡åˆ†æˆå°å—ï¼Œä½¿ç”¨åµŒå…¥æ¨¡å‹å°†å…¶å‘é‡åŒ–ï¼Œå¹¶å­˜å…¥å‘é‡æ•°æ®åº“ï¼Œæ–¹ä¾¿åç»­å¿«é€Ÿæ£€ç´¢ã€‚

**ç¬¬äºŒ**ï¼Œå½“ç”¨æˆ·æé—®æ—¶ï¼Œç³»ç»Ÿä¼šå…ˆå°†é—®é¢˜è½¬ä¸ºå‘é‡ï¼Œç„¶ååœ¨æ•°æ®åº“ä¸­æ£€ç´¢å‡ºæœ€ç›¸å…³çš„å†…å®¹å—ï¼Œæœ€åå°†è¿™äº›å†…å®¹ä¸é—®é¢˜ä¸€èµ·å‘é€ç»™å¤§è¯­è¨€æ¨¡å‹ï¼Œè®©æ¨¡å‹åŸºäºä¸Šä¸‹æ–‡ç”Ÿæˆç­”æ¡ˆã€‚

#### RAG å·¥ä½œæµç¨‹

**1. æ–‡æ¡£æ”¶é›†å’Œåˆ‡å‰²**

- **æ–‡æ¡£æ”¶é›†**ï¼šä»ç½‘é¡µã€PDFã€æ•°æ®åº“ç­‰å„ç§æ¥æºæ”¶é›†åŸå§‹æ–‡æ¡£ã€‚
- **æ–‡æ¡£é¢„å¤„ç†**ï¼šæ¸…æ´—ã€æ ‡å‡†åŒ–æ–‡æœ¬æ ¼å¼ã€‚
- **æ–‡æ¡£åˆ‡å‰²**ï¼šå°†é•¿æ–‡æ¡£åˆ†å‰²æˆé€‚å½“å¤§å°çš„ç‰‡æ®µï¼Œå¯åŸºäºå›ºå®šå¤§å°ã€è¯­ä¹‰è¾¹ç•Œã€é€’å½’åˆ†å‰²ç­–ç•¥ã€‚

**2ã€å‘é‡è½¬æ¢å’Œå­˜å‚¨**

- **å‘é‡è½¬æ¢**ï¼šä½¿ç”¨Embeddingæ¨¡å‹å°†æ–‡æœ¬å—è½¬æ¢ä¸ºé«˜ç»´å‘é‡è¡¨ç¤ºï¼Œä»¥æ•è·æ–‡æœ¬çš„è¯­ä¹‰ç‰¹å¾ã€‚
- **å‘é‡å­˜å‚¨**ï¼šå°†ç”Ÿæˆçš„å‘é‡å’Œå¯¹åº”æ–‡æœ¬å­˜å…¥å‘é‡æ•°æ®åº“ï¼Œæ”¯æŒé«˜æ•ˆçš„ç›¸ä¼¼æ€§æœç´¢ã€‚

**3ã€æ–‡æ¡£è¿‡æ»¤å’Œæ£€ç´¢**

- **æŸ¥è¯¢å¤„ç†**ï¼šå°†ç”¨æˆ·é—®é¢˜è½¬æ¢ä¸ºå‘é‡è¡¨ç¤ºã€‚
- **è¿‡æ»¤æœºåˆ¶**ï¼šåŸºäºå…ƒæ•°æ®ã€å…³é”®è¯æˆ–è‡ªå®šä¹‰è§„åˆ™è¿›è¡Œè¿‡æ»¤ã€‚
- **ç›¸ä¼¼åº¦æœç´¢**ï¼šåœ¨å‘é‡æ•°æ®åº“ä¸­æŸ¥æ‰¾ä¸é—®é¢˜å‘é‡æœ€ç›¸ä¼¼çš„æ–‡æ¡£å—ï¼Œå¸¸ç”¨ç®—æ³•æœ‰ä½™å¼¦ç›¸ä¼¼åº¦ã€æ¬§æ°è·ç¦»ç­‰ã€‚
- **ä¸Šä¸‹æ–‡ç»„è£…**ï¼šå°†æ£€ç´¢åˆ°çš„å¤šä¸ªæ–‡æ¡£å—ç»„è£…æˆè¿è´¯ä¸Šä¸‹æ–‡ã€‚

**4ã€æŸ¥è¯¢å¢å¼ºå’Œå…³è”**

- **æç¤ºè¯ç»„è£…**ï¼šå°†æ£€ç´¢åˆ°çš„ç›¸å…³æ–‡æ¡£ä¸ç”¨æˆ·é—®é¢˜ç»„åˆæˆå¢å¼ºæç¤ºã€‚
- **ä¸Šä¸‹æ–‡èåˆ**ï¼šå¤§æ¨¡å‹åŸºäºå¢å¼ºæç¤ºç”Ÿæˆå›ç­”ã€‚
- **æºå¼•ç”¨**ï¼šåœ¨å›ç­”ä¸­æ·»åŠ ä¿¡æ¯æ¥æºå¼•ç”¨ã€‚
- **åå¤„ç†**ï¼šæ ¼å¼åŒ–ã€æ‘˜è¦æˆ–å…¶ä»–å¤„ç†ä»¥ä¼˜åŒ–æœ€ç»ˆè¾“å‡ºã€‚

#### RAGç›¸å…³æŠ€æœ¯

- **Embedding**ï¼šå°†æ•°æ®è½¬ä¸ºè¯­ä¹‰å‘é‡ï¼Œç»´åº¦è¶Šé«˜è¯­ä¹‰è¶Šç»†ã€å­˜å‚¨è¶Šå¤§ã€‚
- **å‘é‡æ•°æ®åº“**ï¼šä¸“å­˜å‘é‡ï¼Œé«˜æ•ˆæŸ¥ç›¸ä¼¼(Pineconeï¼ŒMilvus)ï¼Œåˆ†ä¸“ç”¨ / æ‰©å±•å‹ï¼ˆPGVectorï¼ŒRedis-Stackï¼‰ã€‚
- **å¬å›**ï¼šåˆç­›ç²—ç›¸å…³å€™é€‰ï¼Œé€Ÿåº¦å¹¿åº¦ï¼šå¦‚æ•é±¼ å¤§èŒƒå›´æ’’ç½‘~ã€‚
- **ç²¾æ’**ï¼šå¯¹åŒ¹é…åˆ°çš„æ•°æ®è¿›è¡Œä¼˜åŠ£æ’åºï¼Œæœ«æ®µç»†æ’åºï¼Œç”¨ Rank æ¨¡å‹ ç»“åˆå¤šç‰¹å¾æ‰“åˆ†ï¼Œã€‚
- **æ··åˆæ£€ç´¢**ï¼šå„å¤§å‚å•†åŒ¹é…æŠ€æœ¯ï¼Œå…³é”®è¯ + å‘é‡æ£€ç´¢ï¼Œè°ƒæƒé‡ã€‚
  **æ ¸å¿ƒ**ï¼šæ£€ç´¢è¡¥å¤–éƒ¨çŸ¥è¯†ï¼Œç”Ÿæˆæ›´å‡†ï¼Œè§£å¤§æ¨¡å‹æ—¶æ•ˆä¸å¹»è§‰ã€‚

### RAG å®æˆ˜ï¼šSpring AI + æœ¬åœ°çŸ¥è¯†åº“

#### æ ¸å¿ƒæµç¨‹ä¸æ­¥éª¤

**a. æ–‡æ¡£å‡†å¤‡**

- **æ ¼å¼ï¼š**ä½¿ç”¨ç»“æ„åŒ–Markdownæ–‡æ¡£ï¼Œå¼ºè°ƒç»“æ„åŒ–ï¼ˆå¯æ‰”ç»™ AI åˆ†ææˆç»“æ„åŒ–ï¼Œä¸ºåç»­æ›´å‡†ç¡®çš„å›ç­”ï¼‰ã€‚
- **å­˜å‚¨ï¼š**å­˜æ”¾åœ¨æœ¬åœ°èµ„æºç›®å½•ä¸‹ï¼ˆå¦‚resource/*.mdï¼‰ã€‚

**b. æ–‡æ¡£è¯»å–ï¼ˆETLï¼‰**

- åˆ©ç”¨ SpringAI tika + markdown è§£å†³å¤§éƒ¨åˆ†æ‰€æœ‰æ–‡ä»¶~


- DocumentReaderï¼šè¯»å–æ–‡æ¡£ï¼Œå¾—åˆ°æ–‡æ¡£åˆ—è¡¨


- DocumentTransformerï¼šè½¬æ¢æ–‡æ¡£ï¼Œå¾—åˆ°å¤„ç†åçš„æ–‡æ¡£åˆ—è¡¨


- DocumentWriterï¼šå°†æ–‡æ¡£åˆ—è¡¨ä¿å­˜åˆ°å­˜å‚¨ä¸­

```xml
<!-- Markdown æ–‡æ¡£è¯»å–å™¨ -->
<dependency>
    <groupId>org.springframework.ai</groupId>
    <artifactId>spring-ai-markdown-document-reader</artifactId>
</dependency>
			
<!-- Tika æ–‡æ¡£è¯»å–å™¨ -->
<dependency>
    <groupId>org.springframework.ai</groupId>
    <artifactId>spring-ai-tika-document-reader</artifactId>
</dependency>
```

**c. å‘é‡è½¬æ¢ä¸å­˜å‚¨**

- **å·¥å…·**ï¼šå¯ä»¥ä½¿ç”¨Spring AIå†…ç½®çš„SimpleVectorStoreï¼ˆå†…å­˜å‹å‘é‡æ•°æ®åº“ï¼‰ã€‚
- **æµç¨‹**ï¼š åµŒå…¥æ¨¡å‹ DashScope å°†æ–‡æ¡£å†…å®¹è½¬æ¢ä¸ºå‘é‡ã€‚é€šè¿‡VectorStoreä¿å­˜å‘é‡åŠå…ƒæ•°æ®åˆ°å†…å­˜ä¸­ã€‚
- **é…ç½®ç¤ºä¾‹å°†æ–‡ä»¶å­˜å‚¨è‡³å†…å­˜å‘é‡ä¸­ï¼š**

```java
package com.yuan.yuanaiagent.rag;

import jakarta.annotation.Resource;
import org.springframework.ai.document.Document;
import org.springframework.ai.embedding.EmbeddingModel;
import org.springframework.ai.vectorstore.SimpleVectorStore;
import org.springframework.ai.vectorstore.VectorStore;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.List;

/**
 * æ‹çˆ±å¤§å¸ˆå‘é‡æ•°æ®åº“é…ç½®ï¼ˆåˆå§‹åŒ–åŸºäºå†…å­˜çš„å‘é‡æ•°æ®åº“ Beanï¼‰
 */
@Configuration
public class LoveAppVectorStoreConfig {

    @Resource
    private LoveDocumentLoader loveDocumentLoader;

    @Bean
    public VectorStore loveAppVectorStore(EmbeddingModel dashscopeEmbeddingModel) {
        SimpleVectorStore simpleVectorStore = SimpleVectorStore.builder(dashscopeEmbeddingModel).build();
        // åŠ è½½æ–‡æ¡£
        List<Document> documents = loveDocumentLoader.loadMarkdowns();
        simpleVectorStore.add(documents);
        return simpleVectorStore;
    }
}
```

**d. æŸ¥è¯¢å¢å¼º**

- **æœºåˆ¶**ï¼šé€šè¿‡`QuestionAnswerAdvisor`æ‹¦æˆªå™¨å¢å¼ºé—®ç­”æµç¨‹ã€‚
- **æµç¨‹**ï¼šç”¨æˆ·æé—®æ—¶ï¼Œæ‹¦æˆªå™¨æ£€ç´¢å‘é‡æ•°æ®åº“è·å–ç›¸å…³æ–‡æ¡£åˆ‡ç‰‡ã€‚ å°†æ£€ç´¢ç»“æœæ‹¼æ¥è‡³ç”¨æˆ·é—®é¢˜ï¼Œä½œä¸ºAIç”Ÿæˆå›ç­”çš„ä¸Šä¸‹æ–‡ã€‚
- **ä»£ç å¦‚ä¸‹**ï¼š

```java
@Resource
private VectorStore loveAppVectorStore;

/**
 * å’Œ RAG çŸ¥è¯†åº“è¿›è¡Œå¯¹è¯
 *
 * @param message
 * @param chatId
 * @return
 */
public String doChatWithRag(String message, String chatId) {
    ChatResponse chatResponse = chatClient
            .prompt()
            .user(message)
            .advisors(spec -> spec.param(ChatMemory.CONVERSATION_ID, chatId))
            // å¼€å¯æ—¥å¿—ï¼Œä¾¿äºè§‚å¯Ÿæ•ˆæœ
            .advisors(new MyLoggerAdvisor())
            // åº”ç”¨ RAG çŸ¥è¯†åº“é—®ç­”
            .advisors(new QuestionAnswerAdvisor(loveAppVectorStore))
            .call()
            .chatResponse();
    String content = chatResponse.getResult().getOutput().getText();
    log.info("content: {}", content);
    return content;
}
```

**æµ‹è¯•å¦‚ä¸‹ï¼š**

![](./img/pic14.png)

![](./img/pic15.png)

### RAG å®æˆ˜ï¼šSpring AI + äº‘çŸ¥è¯†åº“æœåŠ¡

#### äº‘çŸ¥è¯†åº“å¼€å‘æ¨¡å¼æ¦‚è¿°

**æ ¸å¿ƒç›®æ ‡**ï¼šåˆ©ç”¨äº‘æœåŠ¡ï¼ˆå¦‚é˜¿é‡Œäº‘ç™¾ç‚¼ï¼š[çŸ¥è¯†åº“_å¤§æ¨¡å‹æœåŠ¡å¹³å°ç™¾ç‚¼(Model Studio)-é˜¿é‡Œäº‘å¸®åŠ©ä¸­å¿ƒ](https://help.aliyun.com/zh/model-studio/rag-knowledge-base)ï¼‰ç®€åŒ– RAG å¼€å‘ï¼Œé¿å…æœ¬åœ°éƒ¨ç½²å¤æ‚æ€§ã€‚

- **ä¼˜ç‚¹**ï¼š å¿«é€Ÿéƒ¨ç½²ï¼Œæ— éœ€ç®¡ç†å‘é‡æ•°æ®åº“ã€‚ å¹³å°è‡ªåŠ¨å¤„ç†æ–‡æ¡£è§£æã€åˆ‡ç‰‡ã€å­˜å‚¨ç­‰æµç¨‹ã€‚
- **ç¼ºç‚¹**ï¼š ä¾èµ–ç¬¬ä¸‰æ–¹æœåŠ¡ï¼Œäº§ç”Ÿè´¹ç”¨ã€‚ æ•°æ®éšç§éœ€å¹³å°ä¿éšœã€‚

#### é˜¿é‡Œäº‘ç™¾ç‚¼å¹³å°æ“ä½œ

1. **å‡†å¤‡æ•°æ®æ‰“ä¸Šæ ‡ç­¾**ï¼š åœ¨é˜¿é‡Œäº‘ç™¾ç‚¼çš„ **åº”ç”¨æ•°æ®** æ¨¡å—ä¸Šä¼ æ–‡æ¡£ã€‚å¹³å°è‡ªåŠ¨è§£ææ–‡æ¡£å†…å®¹å’Œç»“æ„ã€‚
2. **åˆ›å»ºçŸ¥è¯†åº“**ï¼š è¿›å…¥ **çŸ¥è¯†åº“** æ¨¡å—ï¼Œæ–°å»ºçŸ¥è¯†åº“å¹¶é€‰æ‹©é…ç½®ã€‚
3. **å¯¼å…¥æ•°æ®åˆ°çŸ¥è¯†åº“**ï¼š

- é€‰æ‹©å·²ä¸Šä¼ çš„æ•°æ®ï¼Œè®¾ç½®é¢„å¤„ç†è§„åˆ™ï¼ˆå¦‚åˆ‡ç‰‡ç­–ç•¥ã€åˆ†æ®µæ–¹å¼ï¼‰ã€‚
- **æ™ºèƒ½åˆ‡ç‰‡**ï¼šå¹³å°è‡ªåŠ¨å°†æ–‡æ¡£åˆ†å‰²ä¸ºåˆç†ç‰‡æ®µï¼ˆå¯æ‰‹åŠ¨è°ƒæ•´ï¼‰ã€‚

4. **ç®¡ç†çŸ¥è¯†åº“**ï¼š

- æŸ¥çœ‹æ–‡æ¡£åŠåˆ‡ç‰‡å†…å®¹ï¼Œæ”¯æŒæ‰‹åŠ¨ç¼–è¾‘åˆ‡ç‰‡ï¼ˆå¦‚è°ƒæ•´è¾¹ç•Œæˆ–åˆå¹¶/æ‹†åˆ†ï¼‰ã€‚

**æ‰©å±•å®˜æ–¹è§£é‡Š ç²¾ç®€ç‰ˆï¼š**

| å‚æ•°ç»„åˆ«       | æ ¸å¿ƒç›®æ ‡                                             | é€‰æ‹©ä¾æ®                                                 |
| -------------- | ---------------------------------------------------- | -------------------------------------------------------- |
| é…ç½®æ¨¡å¼       | ç¡®å®šçŸ¥è¯†åº“çš„åŸºç¡€é…ç½®æ–¹å¼ï¼ˆæ¨èæˆ–è‡ªå®šä¹‰ï¼‰ã€‚           | æ˜¯å¦éœ€è¦çµæ´»è°ƒæ•´æ£€ç´¢å‚æ•°ã€‚                               |
| å‘é‡å­˜å‚¨ç±»å‹   | é€‰æ‹©å‘é‡æ•°æ®åº“ç±»å‹ï¼Œå½±å“å­˜å‚¨èƒ½åŠ›ä¸æ‰©å±•æ€§ã€‚           | æ˜¯å¦éœ€è¦é«˜çº§ç®¡ç†åŠŸèƒ½ï¼ˆå¦‚å®¡è®¡ã€ç›‘æ§ï¼‰ã€‚                   |
| MetadataæŠ½å–   | é€šè¿‡å…ƒæ•°æ®å¢å¼ºæ£€ç´¢å‡†ç¡®æ€§ï¼Œå‡å°‘æ— å…³ç»“æœã€‚             | æ–‡æ¡£æ˜¯å¦åŒ…å«å¯å…³è”çš„ç»“æ„åŒ–å±æ€§ï¼ˆå¦‚äº§å“åç§°ã€æ–‡æ¡£åˆ†ç±»ï¼‰ã€‚ |
| Excelè¡¨å¤´æ‹¼è£…  | ç¡®ä¿ Excel æ•°æ®è¡Œä¸è¡¨å¤´æ­£ç¡®å…³è”ï¼Œé¿å…æ¨¡å‹è¯¯è¯»ã€‚      | æ˜¯å¦æ‰¹é‡å¤„ç†ç»“æ„åŒ– Excel æ–‡ä»¶ã€‚                          |
| æ–‡æ¡£åˆ‡åˆ† Chunk | æ§åˆ¶æ–‡æœ¬åˆ‡ç‰‡çš„ç”Ÿæˆé€»è¾‘ï¼Œç›´æ¥å½±å“æ£€ç´¢ç²¾åº¦ä¸å­˜å‚¨æ•ˆç‡ã€‚ | æ–‡æ¡£æ ¼å¼å¤æ‚åº¦ã€æ˜¯å¦éœ€è¦è¯­ä¹‰åˆ†å‰²ã€‚                       |

#### RAG å¼€å‘

**aã€ é…ç½®äº‘çŸ¥è¯†åº“æ£€ç´¢**

```java
package com.yuan.yuanaiagent.rag;

import com.alibaba.cloud.ai.dashscope.api.DashScopeApi;
import com.alibaba.cloud.ai.dashscope.rag.DashScopeDocumentRetriever;
import com.alibaba.cloud.ai.dashscope.rag.DashScopeDocumentRetrieverOptions;
import lombok.extern.slf4j.Slf4j;
import org.springframework.ai.chat.client.advisor.api.Advisor;
import org.springframework.ai.rag.advisor.RetrievalAugmentationAdvisor;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
@Slf4j
public class LoveAppRagCloudAdvisorConfig {

    // ä»é…ç½®æ–‡ä»¶è¯»å– DashScope API å¯†é’¥
    @Value("${spring.ai.dashscope.api-key}")
    private String dashScopeApiKey;

    // å®šä¹‰ Bean æ–¹æ³•ï¼Œåˆ›å»ºæ£€ç´¢å¢å¼ºé¡¾é—®
    @Bean
    public Advisor loveAppRagCloudAdvisor() {
        // åˆ›å»º DashScope API å®¢æˆ·ç«¯
        DashScopeApi dashScopeApi = DashScopeApi.builder()
                .apiKey(dashScopeApiKey)
                .build();
        // çŸ¥è¯†åº“åç§°
        final String KNOWLEDGE_INDEX = "æ™ºèƒ½åˆ†é…äº¤å‹";
        // åˆ›å»ºæ–‡æ¡£æ£€ç´¢å™¨ï¼Œè¿æ¥æŒ‡å®šçŸ¥è¯†åº“
        DashScopeDocumentRetriever dashScopeDocumentRetriever = new DashScopeDocumentRetriever(dashScopeApi,
                DashScopeDocumentRetrieverOptions.builder()
                        .withIndexName(KNOWLEDGE_INDEX)
                        .build());
        // æ„å»ºå¹¶è¿”å›æ£€ç´¢å¢å¼ºé¡¾é—®
        return RetrievalAugmentationAdvisor.builder()
                .documentRetriever(dashScopeDocumentRetriever)
                .build();
    }
}
```

**bã€é›†æˆåˆ°èŠå¤©æœåŠ¡**

```java
// AI æ‹çˆ±çŸ¥è¯†åº“é—®ç­”åŠŸèƒ½

    @Resource
    private VectorStore loveAppVectorStore;

    @Resource
    private Advisor loveAppRagCloudAdvisor;

    /**
     * å’Œ RAG çŸ¥è¯†åº“è¿›è¡Œå¯¹è¯
     *
     * @param message
     * @param chatId
     * @return
     */
    public String doChatWithRag(String message, String chatId) {
        ChatResponse chatResponse = chatClient
                .prompt()
                .user(message)
                .advisors(spec -> spec.param(ChatMemory.CONVERSATION_ID, chatId))
                // å¼€å¯æ—¥å¿—ï¼Œä¾¿äºè§‚å¯Ÿæ•ˆæœ
//                .advisors(new MyLoggerAdvisor())
                // åº”ç”¨ RAG çŸ¥è¯†åº“é—®ç­”
//                .advisors(new QuestionAnswerAdvisor(loveAppVectorStore))
                // åº”ç”¨ RAG æ£€ç´¢å¢å¼ºæœåŠ¡ï¼ˆåŸºäºäº‘çŸ¥è¯†åº“æœåŠ¡ï¼‰
                .advisors(loveAppRagCloudAdvisor)
                .call()
                .chatResponse();
        String content = chatResponse.getResult().getOutput().getText();
        log.info("content: {}", content);
        return content;
    }
```

**æµ‹è¯•å¦‚å›¾**

![](./img/pic16.png)

![](./img/pic17.png)

**1ã€å‡†å¤‡æ–‡æ¡£åŠ è½½åˆ°é˜¿é‡Œäº‘æ–°çŸ¥è¯†åº“ã€‚**

[ğŸ“å…¨å›½æ‹çˆ±äººä¿¡æ¯.xlsx](https://docs.qq.com/sheet/DUXhiT0xMaFNxWWhi?_bid=1&client=drive_file)

![](./img/pic18.png)

**2ã€ç›´æ¥æµ‹è¯•ï¼Œä¸»è¦è¿˜æ˜¯æ•°æ®ï¼Œå’Œç»“æ„åŒ–å’Œäº‘å¹³å°æŠ€æœ¯ã€‚**

```java
final String KNOWLEDGE_INDEX = "æ™ºèƒ½åˆ†é…äº¤å‹";

@Test
void doChatWithRagcloud() {
    String chatId = UUID.randomUUID().toString();
    String message = "æˆ‘æ˜¯ç‰›é©¬åº§20å²ï¼Œç”·å¤§å­¦ç”Ÿåœ¨å¹¿å·ï¼Œæˆ‘æƒ³æ‰¾å¯¹è±¡~ï¼Œå¸®æˆ‘æ‰¾æ‰¾æœ‰æ²¡æœ‰é€‚åˆæˆ‘çš„";
    String answer =  loveApp.doChatWithRag(message, chatId);
    Assertions.assertNotNull(answer);
}
```

![](./img/pic19.png)

